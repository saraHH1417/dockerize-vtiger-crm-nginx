### مقدمه
برخی اوقات ممکن است شما نیاز داشته باشید که یک قابلیت خاص به ویتایگر اضافه کنید و کدهای مورد نیاز خود را به سی آر ام خود اضافه کنید. در این صورت است که handler ها به شما کمک می‌کند و شما توسط آن می‌توانید به‌راحتی این کار را انجام دهید. اگر شما قصد دارید ماژول خود را توسعه دهید و CRM خود را سفارشی‌سازی کنید؛ حتماً لازم است که کاربرد handler ها را بدانید. پس به شما توصیه می‌کنیم تا پایان این مقاله با ما همراه باشید.  
 <br>
 <br>
 
 ### رویداد ماژول (Module Event) در CRM چیست؟
یکی از مهم ترین عوامل در قابلیت توسعه پذیری سیستم ویتایگر در ساخت انواع ماژول و توسعه و یکپارچه سازی استفاده از Handler ها می باشد .اگر بخواهیم در یک کلمه رویداد های ماژول که توسط Handler ها مدیریت میشوند را تعریف کنیم میتوان گفت رویداد ها در ویتایگر در زمان وقوع وقایع که در درخواست های مختلف انجام می شود فراخوانی میشوند. این اطلاعات ارسالی این رویدادها می توان تغییر داد یا از آنها برای مقاصد دیگر استفاده کرد.
<br>
برای مثال میخواهید یک اعلان ایمیل را برای یک اقدام خاص اضافه کنید، در نهایت باید کد اصلی vtiger را تغییر دهید تا عملکرد خود را اضافه کنید. رویداد ماژول یک راه ساده برای اضافه کردن اکشن ها بدون ایجاد هیچ تغییری در هسته ویتایگر ارائه می دهد.
 
 <br>
 <br>

### انواع رویداد ها در ویتایگر استاندارد
در ادامه تمام رویدادهای ویتایگر که شما میتوانید به اطلاعات آنها دسترسی داشته باشید آورده شده است.
 
 <br>
 <br>

#### 💡 رویداد vtiger.entity.beforesave
این رویداد قبل از ذخیره شدن یک رکورد در Entity ماژول ها فراخوانی می شود و یک شی VTEntityData به شما ارسال می شود که نشان دهنده محتوای رکورد برای ذخیره می باشد. لازم به ذکر است که رکوردهای جدید دارای شناسه (id) نخواهند بود. شما می توانید محتویات entityData را پیش از ذخیره تغییر دهید لذا باید کمی مراقب باشید زیرا ممکن است اطلاعات رکورد را خراب کنید.

در مثال زیر در زمان فراخوانی این رویداد همیشه هنگام ذخیره، فیلد ارجاع به اختصاص داده شده را به admin تغییر می دهد. با این کار مطمئن خواهید شد که ادمین مالک همه رکورد های جدید یا ذخیره شده خواهد بود.


```
entityData->set('assigned_to_id', '1');
```

> ``📝`` نکته:
> از آنجایی که محتوای رکورد پیش از ذخیره قابل تغییر است، دو رویداد فرعی مربوط به vtiger.entity.beforesave وجود دارد.

 <br>

#### 💡 رویداد vtiger.entity.beforesave.modifiable
این رویداد قبل از رویداد vtiger.entity.beforesave فراخوانی می شود. اگر می‌خواهید محتوای رکورد ارسالی را قبل از ذخیره آن تغییر دهید، از این رویداد استفاده کنید.

 <br>
 <br>

#### 💡 رویداد vtiger.entity.beforesave.final
این رویداد بعد از رویداد vtiger.entity.beforesave فراخوانی می شود. اگر می‌خواهید محتوای رکورد ارسالی را قبل از ذخیره آن تغییر دهید، از این رویداد استفاده کنید.

 <br>
 <br>

#### 💡 رویداد vtiger.entity.aftersave
این رویداد پس از ذخیره یک Entity رکورد فراخوانی می شود و یک شی از نوع VTEntityData را به عنوان ورودی میگیرد. در اینجا یک مثال ساده وجود دارد که زمان ویرایش را هنگام ذخیره یک رکورد لاگ میگیرد.


```
global $log; 
$log->debug($data->getModuleName()":".$data->getId().":".$data->get('modifiedtime'));
 ```

 <br>
 <br>

#### 💡 رویداد vtiger.entity.aftersave.final
این رویداد بعد از رویداد vtiger.entity.aftersave فراخوانی می شود و از آن اطلاعات رکورد ذخیره شده می توانید برای کد نویسی های خود استفاده نمایید.


 <br>
 <br>

#### 💡 رویداد vtiger.batchevent.save
این رویداد بعد از ایجاد رکورد به صورت زمانبندی و یا با ورود اطلاعات از فایل اکسل فراخوانی می شود و از آن اطلاعات رکورد ذخیره شده می توانید برای کد نویسی های خود استفاده نمایید.


 <br>
 <br>

#### 💡 رویداد vtiger.entity.beforedelete
این رویداد پیش از حذف یک Entity رکورد فراخوانی می شود و یک شی از نوع VTEntityData را به عنوان ورودی میگیرد.

برای مثال میتوانید با نمایش پیام زیر اجازه حذف رکورد را به کاربر ندهید.

```
throw new AppException('Record is not deletable!.');
```

 <br>
 <br>

#### 💡 رویداد vtiger.entity.afterdelete
این رویداد پس از حذف یک Entity رکورد فراخوانی می شود و یک شی از نوع VTEntityData را به عنوان ورودی میگیرد و از اطلاعات آن میتوانید نظیر آی دی رکورد حذف شده میتوانید جهت توسعه های خود استفاده نمایید. 


 <br>
 <br>

#### 💡 رویداد vtiger.batchevent.delete
 رویداد پس از حذف یک Entity رکورد به صورت حذف گروهی فراخوانی می شود و یک شی از نوع VTEntityData را به عنوان ورودی میگیرد و از اطلاعات آن میتوانید نظیر آی دی رکورد حذف شده میتوانید جهت توسعه های خود استفاده نمایید. 

 <br>
 <br>

#### 💡 رویداد vtiger.entity.afterrestore
این رویداد پس از بازیابی یک رکورد در Entity ماژول ها از سطل بازیابی فراخوانی می شود و یک شی VTEntityData به شما ارسال می شود که نشان دهنده محتوای رکورد برای استفاده توسعه دهنده می باشد. 


 <br>
 <br>

#### 💡 رویداد vtiger.lead.convertlead
این رویداد پس از تبدیل یک سرنخ به مخاطب ، سازمان یا فرصت فراخوانی میشود و شما میتوانید اطلاعات رکورد های جدید ایجاد شده و رکورد اصلی که اطلاعات به آن منتقل میشود را از طریق کد زیر دریافت نمایید.

```
$convertedEntityIdsInfo = $entityData->entityIds;  //رکورد های ایجاد شده
$transferRelatedRecordsTo = $entityData->transferRelatedRecordsTo; // ماژول اصلی که اطلاعات رد آن ذخیره شده است
```

 <br>
 <br>

#### 💡 رویداد vtiger.picklist.afterrename
این رویداد پس از تغییر نام یک فهرست انتخابی فراخوانی میشود و در صورت نیاز میتوانیذ از طریق مقادیر زیر به محتوای جدید و قدیم دسترسی داشته باشید.

```
$entityData['newvalue'];  //مقدار جدید فهرست انتخابی
$entityData['oldvalue'];  //مقدار قدیم فهرست انتخابی
```

 <br>
 <br>

#### 💡 رویداد vtiger.picklist.afterdelete
 رویداد پس از حذف  یک فهرست انتخابی فراخوانی میشود و در صورت نیاز میتوانیذ از طریق مقادیر زیر به محتوای چایگزین شده و حرف شده دسترسی داشته باشید.


```
$entityData['replacevalue'];  //مقدار جدیدی که اطلاعات قبلی با آن جایگزین می شوند
$entityData['valuetodelete'];  // مقداری که حذف شده است
```

 <br>
 <br>

### راهنمای توسعه در ویتایگر
پس از کلیک بر روی فعال سازی **فعال سازی Handler های سفارشی** فایل موجود در مسیر زیر 
از
```
modules/ParsVT/handlers/CustomHandler.php.rename
```

به 

```
modules/ParsVT/handlers/CustomHandler.php
```
تغییر نام میدهد و شما میتوانید کد های مورد نظر خود را در این فایل در بخش هر رویداد به صورت مجزا وارد نمایید

 <br>
 <br>

### شی VTEntityData در ویتایگر
شی VTEntityData دسترسی به Entity رکورد ها را فراهم می کند و توابع  زیر را در دسترس برنامه نویس قرار میدهد.

#### 💡 تابع getModuleName
نام ماژول را باز میگرداند

#### 💡 تابع getId
شناسه Id رکورد را برمی‌گرداند، اگر رکورد جدید باشد و هنوز ذخیره نشده باشد، خالی خواهد شد.

#### 💡 تابع getData
فیلدهای رکورد را به صورت آرایه ای برمی گرداند که در آن نام فیلد کلید آرایه و مقدار فیلد ، مقدار آرایه است.


#### 💡 تابع isNew
اگر رکورد جدیدی ایجاد شود true را برمی‌گرداند، در غیر این صورت false را برمی‌گرداند.


#### ویرایش فیلد های یک شی Entity 
در رویدادهای خاص، به عنوان مثال، "vtiger.entity.beforesave.modifiable" ممکن است موجودیت را تغییر دهید تا ذخیره شود.

 به عنوان مثال، برای یک شی VTEntityData به نام $data، می توانید فیلد simple_field را با استفاده از کد زیر به مقدار "value" تغییر دهید.
```
$entityData->set('simple_field', 'value');
```
اکنون مقدار با ذخیره simple_field به مقدار "value" ذخیره می شود.