!function(){function t(t,n){this.x=t,this.y=n,this.reverse=function(){return new this.constructor(-1*this.x,-1*this.y)},this._length=null,this.getLength=function(){return this._length||(this._length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))),this._length};var e=function(t){return Math.round(t/Math.abs(t))};this.resizeTo=function(t){if(0===this.x&&0===this.y)this._length=0;else if(0===this.x)this._length=t,this.y=t*e(this.y);else if(0===this.y)this._length=t,this.x=t*e(this.x);else{var n=Math.abs(this.y/this.x),i=Math.sqrt(Math.pow(t,2)/(1+Math.pow(n,2))),s=n*i;this._length=t,this.x=i*e(this.x),this.y=s*e(this.y)}return this},this.angleTo=function(t){var n=this.getLength()*t.getLength();return 0===n?0:Math.acos(Math.min(Math.max((this.x*t.x+this.y*t.y)/n,-1),1))/Math.PI}}function n(n,e){this.x=n,this.y=e,this.getVectorToCoordinates=function(n,e){return new t(n-this.x,e-this.y)},this.getVectorFromCoordinates=function(t,n){return this.getVectorToCoordinates(t,n).reverse()},this.getVectorToPoint=function(n){return new t(n.x-this.x,n.y-this.y)},this.getVectorFromPoint=function(t){return this.getVectorToPoint(t).reverse()}}function e(t,e,a){var o=this.$parent=$(t),h=this.eventTokens={},c=(this.events=new r(this),$.fn[i]("globalEvents")),u={width:"ratio",height:"ratio",sizeRatio:4,color:"#000","background-color":"#fff","decor-color":"#eee",lineWidth:0,minFatFingerCompensation:-10,showUndoButton:!1,data:[]};$.extend(u,function(t){for(var n,e,i=t.css("color"),s=t[0],r=!1;s&&!e&&!r;){try{n=$(s).css("background-color")}catch(t){n="transparent"}"transparent"!==n&&"rgba(0, 0, 0, 0)"!==n&&(e=n),r=s.body,s=s.parentNode}var a,o=/rgb[a]*\((\d+),\s*(\d+),\s*(\d+)/,h=/#([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})/;n=void 0,(n=i.match(o))?a={r:parseInt(n[1],10),g:parseInt(n[2],10),b:parseInt(n[3],10)}:(n=i.match(h))&&(a={r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)});var c;e?(n=void 0,(n=e.match(o))?c={r:parseInt(n[1],10),g:parseInt(n[2],10),b:parseInt(n[3],10)}:(n=e.match(h))&&(c={r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)})):c=a&&Math.max.apply(null,[a.r,a.g,a.b])>127?{r:0,g:0,b:0}:{r:255,g:255,b:255};var u,l,d,f=function(t){return"rgb("+[t.r,t.g,t.b].join(", ")+")"};if(a&&c){var g=Math.max.apply(null,[a.r,a.g,a.b]);l=Math.max.apply(null,[c.r,c.g,c.b]),u={r:d=Math.round(l+-1*(l-g)*.75),g:d,b:d}}else if(a){var p=1;(l=Math.max.apply(null,[a.r,a.g,a.b]))>127&&(p=-1),u={r:d=Math.round(l+96*p),g:d,b:d}}else u={r:191,g:191,b:191};return{color:i,"background-color":c?f(c):e,"decor-color":f(u)}}(o)),e&&$.extend(u,e),this.settings=u;for(var l in a)a.hasOwnProperty(l)&&a[l].call(this,l);this.events.publish(i+".initializing"),this.$controlbarUpper=$('<div style="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1em !important;margin-bottom:1em !important;"></div>').appendTo(o),this.isCanvasEmulator=!1;var d=this.canvas=this.initializeCanvas(u),f=$(d);this.$controlbarLower=$('<div style="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1.5em !important;margin-bottom:1.5em !important;"></div>').appendTo(o),this.canvasContext=d.getContext("2d"),f.data(i+".this",this),u.lineWidth=function(t,n){return t||Math.max(Math.round(n/400),2)}(u.lineWidth,d.width),this.lineCurveThreshold=3*u.lineWidth,u.cssclass&&""!=$.trim(u.cssclass)&&f.addClass(u.cssclass),this.fatFingerCompensation=0;var g=function(t){var e,i,r=function(s){var r=s.changedTouches&&s.changedTouches.length>0?s.changedTouches[0]:s;return new n(Math.round(r.pageX+e),Math.round(r.pageY+i)+t.fatFingerCompensation)},a=new s(750,function(){t.dataEngine.endStroke()});return this.drawEndHandler=function(n){try{n.preventDefault()}catch(t){}a.clear(),t.dataEngine.endStroke()},this.drawStartHandler=function(n){n.preventDefault(),function(){var n=$(t.canvas).offset();e=-1*n.left,i=-1*n.top}(),t.dataEngine.startStroke(r(n)),a.kick()},this.drawMoveHandler=function(n){n.preventDefault(),t.dataEngine.inStroke&&(t.dataEngine.addToStroke(r(n)),a.kick())},this}.call({},this);return function(t,n,e){var s=this.canvas,r=$(s);this.isCanvasEmulator?(r.bind("mousemove."+i,e),r.bind("mouseup."+i,t),r.bind("mousedown."+i,n)):(s.ontouchstart=function(i){s.onmousedown=void 0,s.onmouseup=void 0,s.onmousemove=void 0,this.fatFingerCompensation=u.minFatFingerCompensation&&-3*u.lineWidth>u.minFatFingerCompensation?-3*u.lineWidth:u.minFatFingerCompensation,n(i),s.ontouchend=t,s.ontouchstart=n,s.ontouchmove=e},s.onmousedown=function(i){s.ontouchstart=void 0,s.ontouchend=void 0,s.ontouchmove=void 0,n(i),s.onmousedown=n,s.onmouseup=t,s.onmousemove=e})}.call(this,g.drawEndHandler,g.drawStartHandler,g.drawMoveHandler),h[i+".windowmouseup"]=c.subscribe(i+".windowmouseup",g.drawEndHandler),this.events.publish(i+".attachingEventHandlers"),function(t,n,e,i){"use strict";"ratio"!==n&&"%"!==n.split("")[n.length-1]||(this.eventTokens[e+".parentresized"]=i.subscribe(e+".parentresized",function(n,s,r,a){return function(){var a=s.width();if(a!==r){for(var o in n)n.hasOwnProperty(o)&&(i.unsubscribe(n[o]),delete n[o]);var h=t.settings;t.$parent.children().remove();for(var o in t)t.hasOwnProperty(o)&&delete t[o];h.data=function(t,n){var e,i,s,r,a,o,h=[];for(i=0,s=t.length;i<s;i++){for(e={x:[],y:[]},r=0,a=(o=t[i]).x.length;r<a;r++)e.x.push(o.x[r]*n),e.y.push(o.y[r]*n);h.push(e)}return h}(h.data,1*a/r),s[e](h)}}}(this.eventTokens,this.$parent,this.$parent.width(),(this.canvas.width,this.canvas.height))))}.call(this,this,u.width.toString(10),i,c),this.resetCanvas(u.data),this.events.publish(i+".initialized"),this}var i="jSignature",s=function(t,n){var e;return this.kick=function(){clearTimeout(e),e=setTimeout(n,t)},this.clear=function(){clearTimeout(e)},this},r=function(t){"use strict";this.topics={},this.context=t||this,this.publish=function(t,n,e,i){if(this.topics[t]){var s,r,a,o,h=this.topics[t],c=Array.prototype.slice.call(arguments,1),u=[];for(r=0,a=h.length;r<a;r++)s=(o=h[r])[0],o[1]&&(o[0]=function(){},u.push(r)),s.apply(this.context,c);for(r=0,a=u.length;r<a;r++)h.splice(u[r],1)}},this.subscribe=function(t,n,e){return this.topics[t]?this.topics[t].push([n,e]):this.topics[t]=[[n,e]],{topic:t,callback:n}},this.unsubscribe=function(t){if(this.topics[t.topic])for(var n=this.topics[t.topic],e=0,i=n.length;e<i;e++)n[e][0]===t.callback&&n.splice(e,1)}},a=function(t,n,e,i,s){t.beginPath(),t.moveTo(n,e),t.lineTo(i,s),t.stroke()},o=function(t,n,e,i,s,r,a,o,h){t.beginPath(),t.moveTo(n,e),t.bezierCurveTo(r,a,o,h,i,s),t.stroke()},h=function(t){!function(t,n,e,i){var s=t.fillStyle;t.fillStyle=t.strokeStyle,t.fillRect(n+i/-2,e+i/-2,i,i),t.fillStyle=s}(this.canvasContext,t.x[0],t.y[0],this.settings.lineWidth)},c=function(e,i){var s=new n(e.x[i-1],e.y[i-1]),r=new n(e.x[i],e.y[i]),h=s.getVectorToPoint(r);if(i>1){var c,u=new n(e.x[i-2],e.y[i-2]),l=u.getVectorToPoint(s);if(l.getLength()>this.lineCurveThreshold){c=i>2?new n(e.x[i-3],e.y[i-3]).getVectorToPoint(u):new t(0,0);var d=.35*l.getLength(),f=l.angleTo(c.reverse()),g=h.angleTo(l.reverse()),p=new t(c.x+l.x,c.y+l.y).resizeTo(Math.max(.05,f)*d),v=new t(l.x+h.x,l.y+h.y).reverse().resizeTo(Math.max(.05,g)*d);o(this.canvasContext,u.x,u.y,s.x,s.y,u.x+p.x,u.y+p.y,s.x+v.x,s.y+v.y)}}h.getLength()<=this.lineCurveThreshold&&a(this.canvasContext,s.x,s.y,r.x,r.y)},u=function(e){var i=e.x.length-1;if(i>0){var s,r=new n(e.x[i],e.y[i]),h=new n(e.x[i-1],e.y[i-1]),c=h.getVectorToPoint(r);if(c.getLength()>this.lineCurveThreshold)if(i>1){var u=new t((s=new n(e.x[i-2],e.y[i-2]).getVectorToPoint(h)).x+c.x,s.y+c.y).resizeTo(c.getLength()/2);o(this.canvasContext,h.x,h.y,r.x,r.y,h.x+u.x,h.y+u.y,r.x,r.y)}else a(this.canvasContext,h.x,h.y,r.x,r.y)}};e.prototype.resetCanvas=function(t){var n=this.canvas,e=this.settings,s=this.canvasContext,r=this.isCanvasEmulator,o=n.width,l=n.height;s.clearRect(0,0,o+30,l+30),s.shadowColor=s.fillStyle=e["background-color"],r&&s.fillRect(0,0,o+30,l+30),s.lineWidth=Math.ceil(parseInt(e.lineWidth,10)),s.lineCap=s.lineJoin="round",s.strokeStyle=e["decor-color"],s.shadowOffsetX=0,s.shadowOffsetY=0;var d=Math.round(l/5);a(s,1.5*d,l-d,o-1.5*d,l-d),s.strokeStyle=e.color,r||(s.shadowColor=s.strokeStyle,s.shadowOffsetX=.5*s.lineWidth,s.shadowOffsetY=-.6*s.lineWidth,s.shadowBlur=0),t||(t=[]);var f=this.dataEngine=new function(t,n,e,i,s){if(this.data=t,this.context=n,t.length)for(var r,a,o=t.length,h=0;h<o;h++){a=(r=t[h]).x.length,e.call(n,r);for(var c=1;c<a;c++)i.call(n,r,c);s.call(n,r)}this.changed=function(){},this.startStrokeFn=e,this.addToStrokeFn=i,this.endStrokeFn=s,this.inStroke=!1,this._lastPoint=null,this._stroke=null,this.startStroke=function(t){if(t&&"number"==typeof t.x&&"number"==typeof t.y){this._stroke={x:[t.x],y:[t.y]},this.data.push(this._stroke),this._lastPoint=t,this.inStroke=!0;var n=this._stroke,e=this.startStrokeFn,i=this.context;return setTimeout(function(){e.call(i,n)},3),t}return null},this.addToStroke=function(t){if(this.inStroke&&"number"==typeof t.x&&"number"==typeof t.y&&Math.abs(t.x-this._lastPoint.x)+Math.abs(t.y-this._lastPoint.y)>4){var n=this._stroke.x.length;this._stroke.x.push(t.x),this._stroke.y.push(t.y),this._lastPoint=t;var e=this._stroke,i=this.addToStrokeFn,s=this.context;return setTimeout(function(){i.call(s,e,n)},3),t}return null},this.endStroke=function(){var t=this.inStroke;if(this.inStroke=!1,this._lastPoint=null,t){var n=this._stroke,e=this.endStrokeFn,i=this.context,s=this.changed;return setTimeout(function(){e.call(i,n),s.call(i)},3),!0}return null}}(t,this,h,c,u);return e.data=t,$(n).data(i+".data",t).data(i+".settings",e),f.changed=function(t,n,e){"use strict";return function(){n.publish(e+".change"),t.trigger("change")}}(this.$parent,this.events,i),f.changed(),!0},e.prototype.initializeCanvas=function(t){var n=document.createElement("canvas"),e=$(n);return t.width===t.height&&"ratio"===t.height&&(t.width="100%"),e.css("margin",0).css("padding",0).css("border","none").css("height","ratio"!==t.height&&t.height?t.height.toString(10):1).css("width","ratio"!==t.width&&t.width?t.width.toString(10):1),e.appendTo(this.$parent),"ratio"===t.height?e.css("height",Math.round(e.width()/t.sizeRatio)):"ratio"===t.width&&e.css("width",Math.round(e.height()*t.sizeRatio)),e.addClass(i),n.width=e.width(),n.height=e.height(),this.isCanvasEmulator=function(t){if(t.getContext)return!1;var n=t.ownerDocument.parentWindow,e=n.FlashCanvas?t.ownerDocument.parentWindow.FlashCanvas:"undefined"==typeof FlashCanvas?void 0:FlashCanvas;if(e){t=e.initElement(t);var i=1;if(n&&n.screen&&n.screen.deviceXDPI&&n.screen.logicalXDPI&&(i=1*n.screen.deviceXDPI/n.screen.logicalXDPI),1!==i)try{$(t).children("object").get(0).resize(Math.ceil(t.width*i),Math.ceil(t.height*i)),t.getContext("2d").scale(i,i)}catch(t){}return!0}throw new Error("Canvas element does not support 2d context. jSignature cannot proceed.")}(n),n.onselectstart=function(t){return t&&t.preventDefault&&t.preventDefault(),t&&t.stopPropagation&&t.stopPropagation(),!1},n};!function(t){function n(t,n,e){"use strict";var i=new Image,s=this;i.onload=function(){s.getContext("2d").drawImage(i,0,0,i.width<s.width?i.width:s.width,i.height<s.height?i.height:s.height)},i.src="data:"+n+","+t}function s(t){return this.find("canvas."+i).add(this.filter("canvas."+i)).data(i+".this").resetCanvas(t),this}function a(t,n){if(void 0!==n||"string"!=typeof t||"data:"!==t.substr(0,5)||(n=t.slice(5).split(",")[0],t=t.slice(6+n.length),n!==t)){var e=this.find("canvas."+i).add(this.filter("canvas."+i));if(!u.hasOwnProperty(n))throw new Error(i+" is unable to find import plugin with for format '"+String(n)+"'");return 0!==e.length&&u[n].call(e[0],t,n,function(t){return function(){return t.resetCanvas.apply(t,arguments)}}(e.data(i+".this"))),this}}var o=new r;!function(t,n,e,i){"use strict";var s,r=function(){t.publish(n+".parentresized")};e(i).bind("resize."+n,function(){s&&clearTimeout(s),s=setTimeout(r,500)}).bind("mouseup."+n,function(e){t.publish(n+".windowmouseup")})}(o,i,$,t);var h={},c={default:function(t){return this.toDataURL()},native:function(t){return t},image:function(t){var n=this.toDataURL();if("string"==typeof n&&n.length>4&&"data:"===n.slice(0,5)&&-1!==n.indexOf(",")){var e=n.indexOf(",");return[n.slice(5,e),n.substr(e+1)]}return[]}},u={native:function(t,n,e){e(t)},image:n,"image/png;base64":n,"image/jpeg;base64":n,"image/jpg;base64":n},l={export:c,import:u,instance:h},d={init:function(t){return this.each(function(){(function(t){var n=!1;for(t=t.parentNode;t&&!n;)n=t.body,t=t.parentNode;return!n})(this)||new e(this,t,h)})},getSettings:function(){return this.find("canvas."+i).add(this.filter("canvas."+i)).data(i+".this").settings},clear:s,reset:s,addPlugin:function(t,n,e){return l.hasOwnProperty(t)&&(l[t][n]=e),this},listPlugins:function(t){var n=[];if(l.hasOwnProperty(t)){var e=l[t];for(var i in e)e.hasOwnProperty(i)&&n.push(i)}return n},getData:function(t){var n=this.find("canvas."+i).add(this.filter("canvas."+i));if(void 0===t&&(t="default"),0!==n.length&&c.hasOwnProperty(t))return c[t].call(n.get(0),n.data(i+".data"))},importData:a,setData:a,globalEvents:function(){return o},events:function(){return this.find("canvas."+i).add(this.filter("canvas."+i)).data(i+".this").events}};$.fn[i]=function(t){"use strict";return t&&"object"!=typeof t?"string"==typeof t&&d[t]?d[t].apply(this,Array.prototype.slice.call(arguments,1)):void $.error("Method "+String(t)+" does not exist on jQuery."+i):d.init.apply(this,arguments)}}(window)}();