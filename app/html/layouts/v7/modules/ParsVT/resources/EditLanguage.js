/* ********************************************************************************
 * The content of this file is subject to the VTFarsi.ir Modules License("License");
 * You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is VTFarsi.ir
 * Portions created by VTFarsi.ir. are Copyright(C) VTFarsi Team
 * All Rights Reserved.
 * ****************************************************************************** */
var delay=function(){var e=0;return function(a,n){clearTimeout(e),e=setTimeout(a,n)}}();jQuery.Class("ParsVT_EditLanguage_Js",{},{registeronSelectChangeEvent:function(){var e=this;jQuery("#listViewContents").empty(),this.ajaxSelectChangeFunction(),jQuery("#SelectLanguage").change(function(){jQuery("#listViewContents").empty(),e.ajaxSelectChangeFunction()}),jQuery("#SelectModule").change(function(){jQuery("#listViewContents").empty(),e.ajaxSelectChangeFunction()})},ajaxSelectChangeFunction:function(){var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),a=this,n=jQuery("#SelectLanguage").val(),t=jQuery("#SelectModule").val(),r=jQuery("#langPrefix").val(),s=jQuery("#trans_search").val(),i={type:"POST",module:app.getModuleName(),parent:"Settings",view:"EditLanguage",previewLang:n,phpModule:t,langPrefix:r,searchvalue:s,dataType:"json"};$("#missingTrans").is(":checked")?i.mode="missingTranslation":$("#missingTrans").is(":checked")||(i.mode="Edit"),AppConnector.request(i).then(function(n){n.success&&(jQuery("#listViewContents").html(n.result),app.changeSelectElementView(jQuery("#langForCreateFile")),a.updateLangTranslation(),a.updateJsLangTranslation(),a.addNewTranslationEvent(),a.createLangFile(),e.progressIndicator({mode:"hide"}))},function(e,a){})},updateLangTranslation:function(){var e=this;jQuery("input[name^='lang_']").each(function(){$(this).on("blur",function(){var a=$(this).val(),n=$(this).closest("tr").data("langkey"),t=$("#for_module_name").val(),r=$("#finally_prefix").val(),s=$(this).closest("tr").data("langtransl");e.saveTranslation(a,r,n,t,"PHP",s)})})},updateJsLangTranslation:function(){var e=this;jQuery("input[name^='jslang_']").each(function(){$(this).on("blur",function(){var a=$(this).val(),n=$(this).closest("tr").data("jslangkey"),t=$("#for_module_name").val(),r=$("#finally_prefix").val(),s=$(this).closest("tr").data("langtransl");e.saveTranslation(a,r,n,t,"JS",s)})})},saveTranslation:function(e,a,n,t,r,s){var i={type:"POST",module:app.getModuleName(),action:"SaveLanguage",newString:e,langPrefix:a,langkey:n,forModuleName:t,variableType:r,dataType:"json"};s!==e&&AppConnector.request(i).then(function(e){var a={message:e.result.message};e.result.success?app.helper.showSuccessNotification(a):app.helper.showErrorNotification(a)},function(e,a){})},addNewTranslationEvent:function(){jQuery("#listViewContents");var e=$("#SelectModule").val(),a=$("#langPrefix").val();e=e.replace("m_",""),$(".addNewTranslation").click(function(n){var t="index.php?module=ParsVT&parent=Settings&view=createTransModalAjax&Module="+e+"&langPrefix="+a;app.request.get({url:t}).then(function(e,a){null===e?app.helper.showModal(a):app.helper.showErrorNotification({message:e.message})})})},addNewTranslation:function(e){var a=jQuery.Deferred(),n=e.serializeFormData(),t=$("#finally_prefix").val(),r=$("#for_module_name").val(),s={type:"POST",module:app.getModuleName(),action:"AddTranslation",formData:n,langPrefix:t,forModuleName:r,dataType:"json"};return AppConnector.request(s).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise()},registerDeleteLanguageVariable:function(){var e=this,a=jQuery(".listViewContentDiv");jQuery(a).on("click",".deleteRecordButton",function(a){var n=$("#for_module_name").val(),t=$("#finally_prefix").val();if(void 0===(r=$(this).closest("tr").data("langkey")))var r=$(this).closest("tr").data("jslangkey");var s={type:"POST",module:app.getModuleName(),action:"DeleteTranslation",langkey:r,langPrefix:t,forModuleName:n,dataType:"json"};AppConnector.request(s).then(function(a){var n={text:a.result.message,type:"info"};Vtiger_Helper_Js.showMessage(n),jQuery("#listViewContents").empty(),e.ajaxSelectChangeFunction()},function(e,a){}),a.stopPropagation()})},registerShowMissingTranslationButtonEvent:function(){var e=this;$("#missingTrans").on("click",function(){var a=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),n=jQuery("#SelectLanguage").val(),t=jQuery("#SelectModule").val(),r=jQuery("#langPrefix").val(),s=jQuery("#trans_search").val(),i={type:"POST",module:app.getModuleName(),parent:"Settings",view:"EditLanguage",previewLang:n,phpModule:t,langPrefix:r,searchvalue:s,dataType:"json"};$(this).is(":checked")?i.mode="missingTranslation":$(this).is(":checked")||(i.mode="Edit"),AppConnector.request(i).then(function(n){n.success&&(jQuery("#listViewContents").html(n.result),e.updateLangTranslation(),e.updateJsLangTranslation(),e.addNewTranslationEvent(),e.createLangFile(),a.progressIndicator({mode:"hide"}))},function(e,a){})})},registerSearchTranslationEvent:function(){var e=this;$("#trans_search").keyup(function(){var a=$(this).val(),n=jQuery("#SelectLanguage").val(),t=jQuery("#SelectModule").val(),r=jQuery("#langPrefix").val(),s={type:"POST",module:app.getModuleName(),parent:"Settings",view:"EditLanguage",previewLang:n,phpModule:t,langPrefix:r,searchvalue:a,dataType:"json"};$("#missingTrans").is(":checked")?s.mode="missingTranslation":$("#missingTrans").is(":checked")||(s.mode="Edit");var i=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});delay(function(){AppConnector.request(s).then(function(a){a.success&&(jQuery("#listViewContents").html(a.result),e.updateLangTranslation(),e.updateJsLangTranslation(),e.addNewTranslationEvent())},function(e,a){})},400),i.progressIndicator({mode:"hide"})})},registerClearSearchTransButtonEvent:function(){var e=this;$("#clear_trans_search").click(function(){$("#trans_search").val(""),jQuery("#listViewContents").empty(),e.ajaxSelectChangeFunction()})},createLangFile:function(){var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}});$("#createLangFile").on("click",function(){var a=$("#langForCreateFile").val(),n=$("#for_module_name").val(),t=$("#finally_prefix").val(),r={type:"POST",module:app.getModuleName(),action:"LanguageAjax",finallyPrefix:t,forModule:n,createLangPrefix:a,mode:"createNewLangFile",dataType:"json"};AppConnector.request(r).then(function(a){e.progressIndicator({mode:"hide"}),a.success?1==a.result.success?app.helper.showSuccessNotification({message:a.result.message}):app.helper.showErrorNotification({message:a.result.message}):app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})},function(a){e.progressIndicator({mode:"hide"}),app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})}),e.progressIndicator({mode:"hide"}),setTimeout(function(){window.location.reload(1)},3e3)})},registerCopyAndSaveTranslationIconEvent:function(){var e=jQuery(".listViewContentDiv");jQuery(e).on("click",".copyToTranslationInputAndSave",function(e){var a=e.currentTarget,n=jQuery(a).closest("td"),t=jQuery(n).siblings(".closestTdWithInput").find("input");jQuery(a).hasClass("jsLang")?jQuery(t).val(n.data("jslangtranslate")):jQuery(t).val(n.data("langtranslate")),jQuery(t).trigger("blur")})},registerTranslate:function(){jQuery.Deferred();jQuery(document).on("click",".modalTranslateSaveButton",function(){var e=jQuery("#langVariable"),a=jQuery("#langTranslation");if(0==e.val().length)$(".langVariableVal")[0]?e.focus():(e.after('<span class="langVariableVal text-danger">'+app.vtranslate("JS_PLEASE_ENTER_VALID_VALUE")+"</span>"),e.focus());else if($(".langVariableVal").remove(),0==a.val().length)$(".langTranslationVal")[0]?a.focus():(a.after('<span class="langTranslationVal text-danger">'+app.vtranslate("JS_PLEASE_ENTER_VALID_VALUE")+"</span>"),a.focus());else{$(".langTranslationVal").remove();var n=jQuery("#newTranslateForm").serializeFormData(),t=jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}}),r={};r.module=app.getModuleName(),r.action="AddTranslation",r.parent="Settings",r.data=n,AppConnector.request(r).then(function(e){t.progressIndicator({mode:"hide"}),e.success?1==e.result.success?app.helper.showSuccessNotification({message:e.result.message}):app.helper.showErrorNotification({message:e.result.message}):app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})},function(e){t.progressIndicator({mode:"hide"}),app.helper.showErrorNotification({message:ParsVTErrors.OPFAILED})}),jQuery(".myModal").hide(),setTimeout(function(){window.location.reload(1)},3e3)}})},registerEvents:function(){this.registerShowMissingTranslationButtonEvent(),this.registeronSelectChangeEvent(),this.registerDeleteLanguageVariable(),this.registerSearchTranslationEvent(),this.registerClearSearchTransButtonEvent(),this.registerCopyAndSaveTranslationIconEvent(),this.registerTranslate(),this.createLangFile()}}),jQuery(document).ready(function(){(new ParsVT_EditLanguage_Js).registerEvents(),vtUtils.enableTooltips()});