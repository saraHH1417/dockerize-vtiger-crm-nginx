/* ********************************************************************************
 * The content of this file is subject to the VTFarsi.ir Modules License("License");
 * You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is VTFarsi.ir
 * Portions created by VTFarsi.ir. are Copyright(C) VTFarsi Team
 * All Rights Reserved.
 * ****************************************************************************** */
var parsvt_calendar_scheduler=0,CalendarHorizontal={Periods:[{Name:"1 days",Label:"Day",StartPeroid:moment().startOf("day",1).add("Milliseconds",1,1),TimeDuration:30,TimeframePeriod:60,TimeframeOverall:1440,TimeframeHeaders:["YYYY/MM/DD","HH:mm"]},{Name:"1 week",Label:"Week",StartPeroid:0,TimeDuration:30,TimeframePeriod:480,TimeframeOverall:10080,TimeframeHeaders:["MM/DD","HH:mm"]},{Name:"1 month",Label:"Month",StartPeroid:0,TimeDuration:30,TimeframePeriod:1440,TimeframeOverall:40320,TimeframeHeaders:["MM/DD","HH:mm"]},{Name:"Custom",Label:"Custom",StartPeroid:0,TimeDuration:30,TimeframePeriod:1440,TimeframeOverall:40320,TimeframeHeaders:["YYYY/MM/DD","HH:mm"],DateRangeValue:"",DateRange:""}],Items:null,Sections:null,Init:function(){if($("#calendar_horizontal_hour_format").length>0){moment().startOf("day",1).add("Milliseconds",1,1);var e=$("#calendar_horizontal_hour_format").val();""==e&&(e=24);var a=$("#calendar_horizontal_start_hour").val(),r=a.split(":");a=parseInt(r[0]);var t=$("#calendar_horizontal_end_hour").val(),n=t.split(":");t=parseInt(n[0]),(t+=1)<=a&&(t=24);var i=$("#calendar_horizontal_time_duration").val();""==i&&(i=30);var o=$("#calendar_horizontal_default_view_type").val();CalendarHorizontal.Periods[0].StartPeroid=a,CalendarHorizontal.Periods[0].TimeframeOverall=CalendarHorizontal.Periods[0].TimeframePeriod*(t-a)*1,CalendarHorizontal.Periods[0].TimeDuration=i,CalendarHorizontal.Periods[1].TimeDuration=i,CalendarHorizontal.Periods[2].TimeDuration=i,12==e&&(CalendarHorizontal.Periods[0].TimeframeHeaders=["YYYY/MM/DD","hh:mma"],CalendarHorizontal.Periods[1].TimeframeHeaders=["MMM","hh:mma"],CalendarHorizontal.Periods[2].TimeframeHeaders=["D","hh:mma"]),TimeScheduler.Options.GetSections=CalendarHorizontal.GetSections,TimeScheduler.Options.GetSchedule=CalendarHorizontal.GetSchedule,TimeScheduler.Options.Periods=CalendarHorizontal.Periods,"1 days"!=o&&"1 week"!=o&&"1 month"!=o?(TimeScheduler.Options.SelectedPeriod="1 days",TimeScheduler.Options.Start=moment().startOf("day",1).add("minutes",60*a)):(TimeScheduler.Options.SelectedPeriod=o,"1 days"==o?TimeScheduler.Options.Start=moment().startOf("day",1).add("minutes",60*a):"1 week"==o?TimeScheduler.Options.Start=moment().startOf("week",1).add("Milliseconds",1,1):"1 month"==o&&(TimeScheduler.Options.Start=moment().startOf("month",1).add("Milliseconds",1,1))),TimeScheduler.Options.Element=$(".calendar"),TimeScheduler.Options.AllowDragging=!0,TimeScheduler.Options.AllowResizing=!0,TimeScheduler.Options.showPopover=!0,TimeScheduler.Options.Events.ItemDropped=CalendarHorizontal.Item_Dragged,TimeScheduler.Options.Events.ItemResized=CalendarHorizontal.Item_Resized,TimeScheduler.Options.Events.ItemClicked=CalendarHorizontal.Item_Clicked,TimeScheduler.Options.Events.Cell_Clicked=CalendarHorizontal.Cell_Clicked,TimeScheduler.Options.Events.ItemMovement=CalendarHorizontal.Item_Movement,TimeScheduler.Options.Events.ItemMovementStart=CalendarHorizontal.Item_MovementStart,TimeScheduler.Options.Events.ItemMovementEnd=CalendarHorizontal.Item_MovementEnd,TimeScheduler.Options.Text.NextButton=" ",TimeScheduler.Options.Text.PrevButton=" ",TimeScheduler.Options.Text.NextDayButton=" ",TimeScheduler.Options.Text.PrevDayButton=" ",TimeScheduler.Options.MaxHeight=100,TimeScheduler.Init(!0)}},GetSections:function(e){var a=jQuery.Deferred(),r=[];jQuery("input[data-calendar-feed]:checked").each(function(){var e=jQuery(this);r.push(e.data("calendarUserid"))});var t={module:"ParsVT",action:"HorizontalAjax",mode:"getUsers",currentView:$("#CalendarViewContent input#currentView").val(),active_users:r};return app.helper.showProgress(),app.request.post({data:t}).then(function(r,t){if(app.helper.hideProgress(),r)a.reject(r);else{var n=t,i=n.length;if(i>0){for(var o=0;o<i;o++)n[o].id=n[o].id,n[o].name=n[o].full_name;CalendarHorizontal.Sections=n}else CalendarHorizontal.Sections=[];e(CalendarHorizontal.Sections),a.resolve(t)}}),a.promise()},GetSchedule:function(e,a,r){var t=jQuery.Deferred(),n=TimeScheduler.GetSelectedPeriod();void 0===a&&(a=TimeScheduler.Options.Start),void 0===r&&(r=TimeScheduler.GetEndOfPeriod(TimeScheduler.Options.Start,n));var i={};jQuery("input[data-calendar-feed]:checked").each(function(){var e=jQuery(this),t=CalendarHorizontal.getFeedRequestParams(a,r,e);i[e.data("calendarSourcekey")]=t});var o={module:"ParsVT",action:"HorizontalAjax",mode:"getActivities",modeType:"batch",feedsRequest:i};return app.helper.showProgress(),app.request.post({data:o}).then(function(a,r){if(app.helper.hideProgress(),a)t.reject(a);else{var n=r,i=n.length;if(i>0){parsvt_calendar_scheduler=1;for(var o=0;o<i;o++)n[o].start=moment(n[o].start),n[o].end=moment(n[o].end);parsvt_calendar_scheduler=0,CalendarHorizontal.Items=n}else CalendarHorizontal.Items=[];e(CalendarHorizontal.Items),t.resolve(r)}}),t.promise()},getFeedRequestParams:function(e,a,r){return{start:e.format("YYYY-MM-DD"),end:a.format("YYYY-MM-DD"),type:r.data("calendarFeed"),fieldname:r.data("calendarFieldname"),color:r.data("calendarFeedColor"),textColor:r.data("calendarFeedTextcolor"),conditions:r.data("calendarFeedConditions"),userid:r.data("calendarUserid"),group:r.data("calendarGroup")}},Item_Clicked:function(e){var a=e.id.split("_");CalendarHorizontal.editCalendarEvent(a[1],e.module)},editCalendarEvent:function(e,a){if(void 0===a)a="Events";var r=jQuery("#is_record_creation_allowed").val();if(!r||"Events"!=a&&"Calendar"!=a)r&&"Events"!=a&&"Calendar"!=a&&CalendarHorizontal.showDetailOverlay(e,a);else{var t=jQuery("#quickCreateModules").find('[data-name="'+a+'"]');if(t.length<=0)app.helper.showAlertNotification({message:app.vtranslate("JS_NO_CREATE_OR_NOT_QUICK_CREATE_ENABLED")});else{var n=t.data("url"),i=n+"&mode=edit&record="+e;t.data("url",i),t.trigger("click"),t.data("url",n),"Events"!==a&&"Calendar"!==a||app.event.one("post.QuickCreateForm.show",function(e,a){CalendarHorizontal.registerEditEventModalEvents(a.closest(".modal"))})}}},showDetailOverlay:function(e,a){if(void 0!==e&&"undefined"!=a){var r={};r.module=a,r.view="Detail",r.mode="showDetailViewByMode",r.requestMode="full",r.displayMode="overlay",r.record=e,app.helper.showProgress(),app.request.get({data:r}).then(function(e,r){app.helper.hideProgress();app.helper.loadPageContentOverlay(r,{backdrop:"static",keyboard:!1}).then(function(e){var r=Vtiger_Detail_Js.getInstanceByModuleName(a);r.showScroll(jQuery(".overlayDetail .modal-body")),r.setModuleName(a),r.setOverlayDetailMode(!0),r.setContentHolder(e.find(".overlayDetail")),r.setDetailViewContainer(e.find(".overlayDetail")),r.registerOverlayEditEvent(),r.registerBasicEvents(),r.registerClickEvent(),r.registerHeaderAjaxEditEvents(e.find(".overlayDetailHeader")),e.find("form#detailView").on("submit",function(e){e.preventDefault()})})})}},deleteCalendarEvent:function(e,a,r){app.helper.showConfirmationBox({message:app.vtranslate("LBL_DELETE_CONFIRMATION")}).then(function(){void 0===r&&(r={});var t={module:"Calendar",action:"DeleteAjax",record:e,sourceModule:a};jQuery.extend(t,r),app.helper.showProgress(),app.request.post({data:t}).then(function(e,a){app.helper.hideProgress(),e?app.helper.showErrorNotification({message:app.vtranslate("JS_NO_DELETE_PERMISSION")}):(TimeScheduler.Init(),app.helper.showSuccessNotification({message:app.vtranslate("JS_RECORD_DELETED")}))})})},markAsHeld:function(e){app.helper.showConfirmationBox({message:app.vtranslate("JS_CONFIRM_MARK_AS_HELD")}).then(function(){var a={module:"Calendar",action:"SaveFollowupAjax",mode:"markAsHeldCompleted",record:e};app.request.post({data:a}).then(function(e,a){e?app.helper.showErrorNotification({message:app.vtranslate("JS_PERMISSION_DENIED")}):a&&!0===a.valid&&!0===a.markedascompleted?TimeScheduler.Init():app.helper.showAlertNotification({message:app.vtranslate("JS_FUTURE_EVENT_CANNOT_BE_MARKED_AS_HELD")})})})},holdFollowUp:function(e){var a=CalendarHorizontal,r={module:"Calendar",view:"QuickCreateFollowupAjax",record:e};app.helper.showProgress(),app.request.get({data:r}).then(function(e,r){app.helper.hideProgress(),!e&&r&&app.helper.showModal(r,{cb:function(e){a.registerCreateFollowUpEvent(e)}})})},registerCreateFollowUpEvent:function(e){var a={submitHandler:function(e){(e=jQuery(e)).find('[type="submit"]').attr("disabled","disabled");var a=e.serializeFormData();app.helper.showProgress(),app.request.post({data:a}).then(function(e,a){app.helper.hideProgress(),app.helper.hideModal(),!e&&a.created?TimeScheduler.Init():app.helper.showErrorNotification({message:app.vtranslate("JS_NO_EDIT_PERMISSION")})})}};e.find("form#followupQuickCreate").vtValidate(a)},registerEditEventModalEvents:function(e){var a={submitHandler:function(e){if(jQuery("button[name='saveButton']").attr("disabled","disabled"),this.numberOfInvalids()>0)return jQuery("button[name='saveButton']").removeAttr("disabled"),!1;var a=jQuery.Event(Vtiger_Edit_Js.recordPresaveEvent);if(app.event.trigger(a),a.isDefaultPrevented())return!1;CalendarHorizontal._updateEvent(e)}};e.find("form").vtValidate(a)},_updateEvent:function(e,a){var r=jQuery(e).serializeFormData();a=a||{},jQuery.extend(r,a),app.helper.showProgress(),app.request.post({data:r}).then(function(a,r){a?app.helper.showErrorNotification({message:a}):(app.helper.showSuccessNotification({message:""}),TimeScheduler.Init()),app.event.trigger("post.QuickCreateForm.save",r,jQuery(e).serializeFormData()),app.helper.hideModal(),app.helper.hideProgress()})},Cell_Clicked:function(e,a,r){var t=new Calendar_Calendar_Js,n=TimeScheduler.Options.Start;parsvt_calendar_scheduler=1;var i=moment(n).add("hours",a*(e.TimeframePeriod/60));parsvt_calendar_scheduler=0,i=TimeScheduler.roundTimeWithDuration(i);if(jQuery("#is_record_creation_allowed").val()){var o=jQuery("#quickCreateModules").find('[data-name="Events"]');o.length<=0?app.helper.showAlertNotification({message:app.vtranslate("JS_NO_CREATE_OR_NOT_QUICK_CREATE_ENABLED")}):o.trigger("click"),app.event.one("post.QuickCreateForm.show",function(e,a){t.performingDayClickOperation=!1;var n=a.closest(".modal");void 0!==i&&i&&($("#calendar_horizontal_time_duration").length>0&&(n.find('input[name="defaultOtherEventDuration"]').val($("#calendar_horizontal_time_duration").val()),n.find('input[name="defaultCallDuration"]').val($("#calendar_horizontal_time_duration").val())),t.setStartDateTime(n,i)),r.id&&n.find("select[name=assigned_user_id] option[value="+r.id+"]").length>0&&n.find("select[name=assigned_user_id]").val(r.id).trigger("change"),CalendarHorizontal.validateAndSaveEvent(a.closest(".modal"))})}},validateAndSaveEvent:function(e){new Calendar_Calendar_Js;var a={submitHandler:function(e){if(jQuery("button[name='saveButton']").attr("disabled","disabled"),this.numberOfInvalids()>0)return!1;var a=jQuery.Event(Vtiger_Edit_Js.recordPresaveEvent);if(app.event.trigger(a),a.isDefaultPrevented())return!1;var r=jQuery(e).serialize();app.helper.showProgress(),app.request.post({data:r}).then(function(e,a){e?app.helper.showErrorNotification({message:e}):(app.helper.showSuccessNotification({message:""}),TimeScheduler.Init()),app.helper.hideModal(),app.helper.hideProgress()})}};e.find("form").vtValidate(a)},Item_Dragged:function(e,a,r,t){for(var n,i=0;i<CalendarHorizontal.Items.length;i++)(n=CalendarHorizontal.Items[i]).id===e.id&&(n.sectionID=a,n.start=r,n.end=t,CalendarHorizontal.Items[i]=n);CalendarHorizontal.updateActivity(e,r.format("YYYY-MM-DD HH:mm"),t.format("YYYY-MM-DD HH:mm"),a)},Item_Resized:function(e,a,r){for(var t,n=0;n<CalendarHorizontal.Items.length;n++)(t=CalendarHorizontal.Items[n]).id===e.id&&(t.start=a,t.end=r,CalendarHorizontal.Items[n]=t);CalendarHorizontal.updateActivity(e,a.format("YYYY-MM-DD HH:mm"),r.format("YYYY-MM-DD HH:mm"))},Item_Movement:function(e,a,r,t){var n=$(this).find(".fc-horizontal-time .event-start-end"),i=$("#time_format").val();if(a=TimeScheduler.roundTimeWithDuration(a),r=TimeScheduler.roundTimeWithDuration(r),12==i)var o=a.format("hh:mm A"),d=r.format("hh:mm A");else var o=a.format("HH:mm"),d=r.format("HH:mm");n.html(o+" - "+d)},Item_MovementStart:function(){},Item_MovementEnd:function(){},updateActivity:function(e,a,r,t){var n=e.id.split("_");void 0===t&&(t=n[0]);var i={};i.module="ParsVT",i.action="HorizontalAjax",i.mode="UpdateActivity",i.record=n[1],i.user_id=t,i.datetime_start=a,i.due_datetime=r,i.target_module=e.module,i.fieldname=e.fieldname;var o=jQuery.Deferred();return app.helper.showProgress(),app.request.post({data:i}).then(function(e,a){app.helper.hideProgress(),e?o.reject(e):(TimeScheduler.Init(),o.resolve(a))}),o.promise()},registerHorizontalCalendar:function(){if(("Calendar"===app.module()&&"Calendar"===app.view()||"Calendar"===app.module()&&"SharedCalendar"===app.view())&&$("#CalendarViewContent .fc-left .fc-button-group").length>0&&0==$("#CalendarViewContent .fc-left .fc-button-group .fc-horizontal-button").length){var e='<button type="button" class="fc-horizontal-button fc-button fc-state-default">'+app.vtranslate("Job Scheduler")+"</button>";$("#CalendarViewContent .fc-left .fc-button-group").append(e),CalendarHorizontal.registerShowHorizontalCalendar()}},processDefaultView:function(){if("Calendar"===app.module()&&"Calendar"===app.view()||"Calendar"===app.module()&&"SharedCalendar"===app.view()){var e=jQuery.Deferred();return app.request.post({data:{module:"ParsVT",action:"HorizontalAjax",mode:"getDefaultView"}}).then(function(a,r){a?e.reject(a):(1==r&&$("#CalendarViewContent .fc-button-group .fc-horizontal-button").trigger("click"),e.resolve(r))}),e.promise()}},registerShowHorizontalCalendar:function(){$("#CalendarViewContent .fc-button-group .fc-horizontal-button").unbind("click").on("click",function(){$("#CalendarViewContent .fc-left .fc-button-group button").removeClass("fc-state-active"),$("#CalendarViewContent .fc-left .fc-button-group .fc-horizontal-button").addClass("fc-state-active"),CalendarHorizontal.showHorizontalCalendar()})},registerFeedAddEvent:function(e){$("#module-filters .add-calendar-feed").off("click"),e.registerFeedAddEvent()},registerFeedDeleteEvent:function(e){jQuery("#calendarview-feeds").off("click",".deleteCalendarFeed"),e.registerFeedDeleteEvent()},registerFeedsColorEditEvent:function(e){jQuery("#calendarview-feeds").off("click",".editCalendarFeedColor"),e.registerFeedsColorEditEvent()},registerOverrideFeedsEvent:function(){if(CalendarHorizontal.registerFeedChangeEvent(),"SharedCalendar"===app.view())e=new Calendar_SharedCalendar_Horizontal_Js;else var e=new Calendar_Horizontal_Js;CalendarHorizontal.registerFeedAddEvent(e),CalendarHorizontal.registerFeedDeleteEvent(e),CalendarHorizontal.registerFeedsColorEditEvent(e)},showHorizontalCalendar:function(){var e=jQuery.Deferred();return app.helper.showProgress(),app.request.post({data:{module:"ParsVT",view:"Horizontal"}}).then(function(a,r){if(app.helper.hideProgress(),a)e.reject(a);else{var t=Calendar_Calendar_Js.getInstance(),n=t.getCalendarViewContainer();n.fullCalendar("destroy"),n.prepend(r),"SharedCalendar"===app.getViewName()?n.find(".fc-vtAgendaList-button").hide():n.find(".fc-vtAgendaList-button").show(),n.find(".fc-month-button").unbind("click").on("click",function(){n.find(".fc-horizontal-view").remove(),t.initializeCalendar(),t.renderEvents(),n.fullCalendar("changeView","month"),CalendarHorizontal.registerHorizontalCalendar(),$("#calendarview-feeds").unbind("change",'input[type="checkbox"].toggleCalendarFeed'),t.registerFeedChangeEvent();var e=$("#module-filters");$("#module-filters .add-calendar-feed").off("click"),t.registerFeedAddEvent(e),jQuery("#calendarview-feeds").off("click",".editCalendarFeedColor"),t.registerFeedsColorEditEvent(),jQuery("#calendarview-feeds").off("click",".deleteCalendarFeed"),t.registerFeedDeleteEvent()}),n.find(".fc-agendaWeek-button").unbind("click").on("click",function(){n.find(".fc-horizontal-view").remove(),t.initializeCalendar(),t.renderEvents(),n.fullCalendar("changeView","agendaWeek"),CalendarHorizontal.registerHorizontalCalendar(),$("#calendarview-feeds").unbind("change",'input[type="checkbox"].toggleCalendarFeed'),t.registerFeedChangeEvent();var e=$("#module-filters");$("#module-filters .add-calendar-feed").off("click"),t.registerFeedAddEvent(e),jQuery("#calendarview-feeds").off("click",".editCalendarFeedColor"),t.registerFeedsColorEditEvent(),jQuery("#calendarview-feeds").off("click",".deleteCalendarFeed"),t.registerFeedDeleteEvent()}),n.find(".fc-agendaDay-button").unbind("click").on("click",function(){n.find(".fc-horizontal-view").remove(),t.initializeCalendar(),t.renderEvents(),n.fullCalendar("changeView","agendaDay"),CalendarHorizontal.registerHorizontalCalendar(),$("#calendarview-feeds").unbind("change",'input[type="checkbox"].toggleCalendarFeed'),t.registerFeedChangeEvent();var e=$("#module-filters");$("#module-filters .add-calendar-feed").off("click"),t.registerFeedAddEvent(e),jQuery("#calendarview-feeds").off("click",".editCalendarFeedColor"),t.registerFeedsColorEditEvent(),jQuery("#calendarview-feeds").off("click",".deleteCalendarFeed"),t.registerFeedDeleteEvent()}),n.find(".fc-vtAgendaList-button").unbind("click").on("click",function(){n.find(".fc-horizontal-view").remove(),t.initializeCalendar(),t.renderEvents(),n.fullCalendar("changeView","vtAgendaList"),CalendarHorizontal.registerHorizontalCalendar(),$("#calendarview-feeds").unbind("change",'input[type="checkbox"].toggleCalendarFeed'),t.registerFeedChangeEvent();var e=$("#module-filters");$("#module-filters .add-calendar-feed").off("click"),t.registerFeedAddEvent(e),jQuery("#calendarview-feeds").off("click",".editCalendarFeedColor"),t.registerFeedsColorEditEvent(),jQuery("#calendarview-feeds").off("click",".deleteCalendarFeed"),t.registerFeedDeleteEvent()}),CalendarHorizontal.registerCalendarSettingsEvent(),CalendarHorizontal.Init(),CalendarHorizontal.registerOverrideFeedsEvent(),e.resolve(r)}}),e.promise()},registerFeedChangeEvent:function(){$('#calendarview-feeds input[type="checkbox"].toggleCalendarFeed').length>0&&$(".fc-button-group .fc-state-active").hasClass("fc-horizontal-button")&&$("#calendarview-feeds").unbind("change").on("change",'input[type="checkbox"].toggleCalendarFeed',function(){CalendarHorizontal.Init()})},registerCalendarSettingsEvent:function(){$(".calendar-horizontal-user-profiles").length>0&&$(".calendar-horizontal-user-profiles").unbind("click").on("click",function(){app.helper.showProgress(),app.request.post({data:{module:"ParsVT",view:"CalendarSettings"}}).then(function(e,a){app.helper.hideProgress(),e?console.log("network error : ",e):app.helper.showModal(a,{cb:function(e){e.find('button[name="saveButton"]').on("click",function(){var a=$(this);a.attr("disabled","disabled");var r=e.find("form"),t=r.find("select.calendar_horizontal_settings_start_hour").val();t=parseInt(t);var n=r.find("select.calendar_horizontal_settings_end_hour").val();if((n=parseInt(n))<=t)return app.helper.showErrorNotification({message:app.vtranslate("End Hour must is greater than Start Hour")}),void a.removeAttr("disabled");var i=r.serialize();app.helper.showProgress(),app.request.post({data:i}).then(function(e,a){e?app.helper.showErrorNotification({message:e}):(app.helper.showSuccessNotification({message:""}),$(".fc-horizontal-view").remove(),CalendarHorizontal.showHorizontalCalendar()),app.helper.hideModal(),app.helper.hideProgress()})})}})})})}};$(document).ready(function(){"Calendar"!=app.module()&&"Calendar"!=app.view()&&"SharedCalendar"!=app.view()||("undefined"!=typeof Calendar_Calendar_Js&&Calendar_Calendar_Js("Calendar_Horizontal_Js",{calendarViewContainer:!1},{deleteFeed:function(e){var a=e.find('input[type="checkbox"].toggleCalendarFeed'),r=this.getFeedDeleteParameters(a);app.helper.showProgress(),app.request.post({data:r}).then(function(a){a?console.log("error : ",a):(e.remove(),app.helper.showSuccessNotification({message:app.vtranslate("JS_CALENDAR_VIEW_DELETED_SUCCESSFULLY")}),CalendarHorizontal.Init()),app.helper.hideProgress()})},registerFeedAddEvent:function(e){var a=this;if(void 0===e)e=$("#module-filters");e.find(".add-calendar-feed").on("click",function(){a.showAddCalendarFeedEditor()})},saveFeedSettings:function(e,a){var r=this,t=e.find('select[name="modulesList"]'),n=t.val(),i=e.find('select[name="fieldsList"]').val(),o=e.find("input.selectedColor").val(),d="";"Events"===n&&""!==(d=e.find('[name="conditions"]').val())&&(d=JSON.stringify(d));var l=e.find(".editorMode").val();if("create"===l){var s=e.find(".selectedType").data("typename");if(e.find('[name="rangeFields"]').is(":checked")){var c=e.find('[name="sourceFieldsList"]').val(),p=e.find('[name="targetFieldsList"]').val();i=c+","+p,s=e.find('[name="sourceFieldsList"] option:selected').text()+","+e.find('[name="targetFieldsList"] option:selected').text()}}var u={module:"Calendar",action:"CalendarUserActions",mode:"addCalendarView",viewmodule:n,viewfieldname:i,viewColor:o,viewConditions:d};app.helper.showProgress(),app.request.post({data:u}).then(function(e,c){if(e)console.log("error occured while saving : ",u,e);else{var p="dark"===app.helper.getColorContrast(o)?"white":"black",f=app.vtranslate("JS_CALENDAR_VIEW_COLOR_UPDATED_SUCCESSFULLY"),m=r._getParsedConditions(d),v=n+"-"+s,h=n+"_"+i;if(m.hasOwnProperty("value")&&(h+="_"+m.value,v=n+"("+app.vtranslate(m.value)+") -"+s),"create"===l){var C=t.find("option:selected").text(),g=jQuery("#calendarview-feeds").find("ul.dummy > li.feed-indicator-template");g.removeClass(".feed-indicator-template");var _=g.clone(!0,!0);_.find("span:first").text(v);var E=_.find(".toggleCalendarFeed");E.attr("data-calendar-sourcekey",h).attr("data-calendar-feed",n).attr("data-calendar-fieldlabel",s).attr("data-calendar-fieldname",i).attr("title",C).attr("checked","checked"),c.type&&E.attr("data-calendar-type",c.type),a=_,jQuery("#calendarview-feeds").find("ul:first").append(a),f=app.vtranslate("JS_CALENDAR_VIEW_ADDED_SUCCESSFULLY")}else a=jQuery("#calendarview-feeds").find('[data-calendar-sourcekey="'+h+'"]').closest(".calendar-feed-indicator");a.css({"background-color":o,color:p});a.find(".toggleCalendarFeed").data("calendarFeedColor",o).data("calendarFeedTextcolor",p).data("calendarFeedConditions",d),CalendarHorizontal.Init(),app.helper.hideProgress(),app.helper.hideModal(),app.helper.showSuccessNotification({message:f})}})}}),"undefined"!=typeof Calendar_SharedCalendar_Js&&Calendar_SharedCalendar_Js("Calendar_SharedCalendar_Horizontal_Js",{calendarViewContainer:!1},{deleteFeed:function(e){var a=e.find('input[type="checkbox"].toggleCalendarFeed'),r=this.getFeedDeleteParameters(a);app.helper.showProgress(),app.request.post({data:r}).then(function(a){a?console.log("error : ",a):(e.remove(),app.helper.showSuccessNotification({message:app.vtranslate("JS_CALENDAR_VIEW_DELETED_SUCCESSFULLY")}),CalendarHorizontal.Init()),app.helper.hideProgress()})},registerFeedAddEvent:function(e){var a=this;if(void 0===e)e=$("#module-filters");e.find(".add-calendar-feed").on("click",function(){a.showAddCalendarFeedEditor()})},saveFeedSettings:function(e){var a=e.find(".selectedType"),r=a.val(),t=a.data("typename"),n=a.data("calendarGroup"),i=e.find(".selectedColor").val(),o=e.find(".editorMode").val(),d={module:"Calendar",action:"CalendarUserActions",mode:"addUserCalendar",selectedUser:r,selectedColor:i};app.helper.showProgress(),app.request.post({data:d}).then(function(e){if(e)console.log("error : ",e);else{var a=jQuery("#calendarview-feeds > ul.feedslist"),d=app.vtranslate("JS_CALENDAR_VIEW_COLOR_UPDATED_SUCCESSFULLY");if("create"===o){var l=jQuery("#calendarview-feeds").find("ul.dummy > li.feed-indicator-template");l.removeClass(".feed-indicator-template");var s=l.clone(!0,!0);s.find("span:first").text(t);s.find(".toggleCalendarFeed").attr("data-calendar-sourcekey","Events_"+r).attr("data-calendar-feed","Events").attr("data-calendar-fieldlabel",t).attr("data-calendar-userid",r).attr("data-calendar-group",n).attr("checked","checked"),a.append(s),d=app.vtranslate("JS_CALENDAR_VIEW_ADDED_SUCCESSFULLY")}var c="dark"===app.helper.getColorContrast(i)?"white":"black",p=a.find('input[data-calendar-userid="'+r+'"]');p.data("calendarFeedColor",i).data("calendarFeedTextcolor",c);p.closest(".calendar-feed-indicator").css({"background-color":i,color:c}),CalendarHorizontal.Init(),app.helper.hideProgress(),app.helper.hideModal(),app.helper.showSuccessNotification({message:d})}})}}),CalendarHorizontal.registerHorizontalCalendar(),CalendarHorizontal.processDefaultView())});