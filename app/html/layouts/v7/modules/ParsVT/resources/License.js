/* ********************************************************************************
 * The content of this file is subject to the VTFarsi.ir Modules License("License");
 * You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is VTFarsi.ir
 * Portions created by VTFarsi.ir. are Copyright(C) VTFarsi Team
 * All Rights Reserved.
 * ****************************************************************************** */
jQuery.Class("ParsVT_License_Js",{},{init:function(){this.initiate()},initiate:function(){var e=jQuery(".installationContents").find(".step").val();this.initiateStep(e)},initiateStep:function(e){var n="step"+e;this.activateHeader(n)},activateHeader:function(e){var n=jQuery(".crumbs ");n.find(".active").removeClass("active"),jQuery("#"+e,n).addClass("active")},recheckLicenseEvent:function(){jQuery("#recheck").on("click",function(){location.reload()})},registerLicenseAgreementEvent:function(){jQuery("#licenseagreement").on("click",function(e){e.stopPropagation();var n="index.php?module="+app.getModuleName()+"&view=Helper&mode=showLicenseAgreement";app.request.get({url:n}).then(function(e,n){null===e?app.helper.showModal(n):app.helper.showErrorNotification({message:e.message})})})},registerActivateLicenseEvent:function(){var e=jQuery.Deferred();jQuery(".installationContents").find('[name="btnActivate"]').click(function(){var n=jQuery("#license_key");if(""===n.val()){var o=app.vtranslate(PVTErrors.EMPTYLICENSEKEY);return vtUtils.showValidationMessage(n,o,{position:{my:"top left",at:"bottom left"}}),e.reject(),e.promise()}var t=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),i={};i.module=app.getModuleName(),i.action="Activate",i.mode="activate",i.license=n.val(),i.tokenname=csrfMagicName,i.tokenval=csrfMagicToken,AppConnector.request(i).then(function(e){if(t.progressIndicator({mode:"hide"}),app.storage.delete("ParsVTMode"),app.storage.delete("ParsVTTime"),e.success){var n=e.result.status,o=e.result.information,i=e.result.form;if(jQuery("#licenseinfo").html(o),"Ok"==n){jQuery(".installationContents").find(".module").val();jQuery("#licensecheck").hide(),jQuery(".need-help").hide(),jQuery("#btnOrder").hide(),jQuery("#btnShop").hide(),jQuery("#Activatebtn").html(i)}}},function(e){console.log("error =",e),t.progressIndicator({mode:"hide"})})}),jQuery("#OfflineInfo").find("#requestofflinekey").click(function(e){var n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),o={},t=jQuery(e.currentTarget).data("request");o.module=app.getModuleName(),o.parent=app.getParentModuleName(),o.action="Activate",o.prekey=jQuery("#prekey").val(),o.mode="offlineactivation",o.type=t,o.tokenname=csrfMagicName,o.tokenval=csrfMagicToken,AppConnector.request(o).then(function(e){if(n.progressIndicator({mode:"hide"}),e.success){var o=e.result.status,t=e.result.message;if(jQuery("#offlineresult").html(t),"Ok"==o){app.helper.showSuccessNotification({message:e.result.message});var i=e.result.offlinekey;jQuery("#offlinerow").show(),jQuery("#downloadofflinekey").show(),jQuery("#converttoonline").show(),jQuery("#backtolicense").hide(),jQuery("#dofflinekey").val(i),document.getElementById("dofflinekey").innerHTML=i,setTimeout(function(){window.location="index.php?module="+app.getModuleName()+"&view=License&parent=Settings"},3e3)}else app.helper.showErrorNotification({message:t})}},function(e){jQuery("#offlinerow").hide(),console.log("error =",e),n.progressIndicator({mode:"hide"})})}),jQuery("#OfflineInfo").find("#dongleactivation").click(function(e){var n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),o={};jQuery(e.currentTarget).data("request");o.module=app.getModuleName(),o.parent=app.getParentModuleName(),o.action="Activate",o.mode="dongleactivation",o.tokenname=csrfMagicName,o.tokenval=csrfMagicToken,AppConnector.request(o).then(function(e){if(n.progressIndicator({mode:"hide"}),e.success){var o=e.result.status,t=e.result.message;jQuery("#offlineresult").html(t),"Ok"==o?(app.helper.showSuccessNotification({message:e.result.message}),setTimeout(function(){window.location.reload()},3e3)):app.helper.showErrorNotification({message:t})}},function(e){jQuery("#offlinerow").hide(),console.log("error =",e),n.progressIndicator({mode:"hide"})})}),jQuery("#OfflineInfo").find("#converttoonline").click(function(){var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),n={};n.module=app.getModuleName(),n.parent=app.getParentModuleName(),n.action="Activate",n.mode="convertToOnline",n.tokenname=csrfMagicName,n.tokenval=csrfMagicToken,AppConnector.request(n).then(function(n){if(e.progressIndicator({mode:"hide"}),n.success){var o=n.result.status,t=n.result.message;jQuery("#offlineresult").html(t),"Ok"==o?(app.helper.showSuccessNotification({message:t}),setTimeout(function(){window.location="index.php?module="+app.getModuleName()+"&view=License&parent=Settings"},3e3)):app.helper.showErrorNotification({message:t})}},function(n){app.helper.showErrorNotification({message:message}),console.log("error =",n),e.progressIndicator({mode:"hide"})})}),jQuery("#OfflineInfo").find("#removedonglekey").click(function(){var e=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),n={};n.module=app.getModuleName(),n.parent=app.getParentModuleName(),n.action="Activate",n.mode="removeDongle",n.tokenname=csrfMagicName,n.tokenval=csrfMagicToken,AppConnector.request(n).then(function(n){if(e.progressIndicator({mode:"hide"}),n.success){var o=n.result.status,t=n.result.message;jQuery("#dongleresult").html(t),"Ok"==o?(app.helper.showSuccessNotification({message:t}),setTimeout(function(){window.location="index.php?module="+app.getModuleName()+"&view=License&parent=Settings"},3e3)):app.helper.showErrorNotification({message:t})}},function(n){app.helper.showErrorNotification({message:message}),console.log("error =",n),e.progressIndicator({mode:"hide"})})}),jQuery("#licenseinfo").find("#finalofflineactivation").click(function(){var e=$("#responsecode").val();if(""==e)return app.helper.showErrorNotification({message:"Response code is empty!"}),jQuery("#offlinelicensemessage").removeClass("alert-success"),jQuery("#offlinelicensemessage").addClass("alert-danger"),jQuery("#offlinelicensemessage").html(app.vtranslate("Response code is empty!")),!1;var n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),o={};o.module=app.getModuleName(),o.parent=app.getParentModuleName(),o.action="Activate",o.mode="saveOfflineActivationKey",o.licensekey=jQuery("#licensekey").val(),o.prekey=jQuery("#prekey").val(),o.finalkey=e,o.tokenname=csrfMagicName,o.tokenval=csrfMagicToken,AppConnector.request(o).then(function(e){if(n.progressIndicator({mode:"hide"}),e.success){var o=e.result.status;e.result.message;"Valid"==o?(jQuery("#offlinelicensemessage").removeClass("alert-danger"),jQuery("#offlinelicensemessage").addClass("alert-success"),jQuery("#offlinelicensemessage").html(e.result.message),jQuery("#offlinelicenseinformation").html(e.result.licenseinfo)):(jQuery("#offlinelicensemessage").removeClass("alert-success"),jQuery("#offlinelicensemessage").addClass("alert-danger"),jQuery("#offlinelicensemessage").html(e.result.message+"<br />"+e.result.warning),jQuery("#offlinelicenseinformation").html(""))}},function(e){app.helper.showErrorNotification({message:message}),jQuery("#offlinelicensemessage").removeClass("alert-success"),jQuery("#offlinelicensemessage").addClass("alert-danger"),jQuery("#offlinelicensemessage").html(app.vtranslate(message)),console.log("error =",e),n.progressIndicator({mode:"hide"})})})},registerInverseLicenseEvent:function(){jQuery.Deferred();jQuery("#LicenseInfo").find("#inverse").click(function(){jQuery("#license_key").prop("disabled",!1),jQuery("#valid").hide(),jQuery("#inverse").hide(),jQuery("#checkkey").show(),jQuery("#licwarning").show()})},registerReactivateLicenseEvent:function(){var e=jQuery.Deferred();if(jQuery("#usbdongle").on("click",function(){jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}});window.location="index.php?module="+app.getModuleName()+"&parent=Settings&view=Dongle"}),jQuery("#offlinekey").on("click",function(){app.helper.showConfirmationBox({message:PVTErrors.OFFLINEEMPTYLICENSEKEY}).then(function(e){jQuery.progressIndicator({message:"",position:"html",blockInfo:{enabled:!0}});window.location="index.php?module="+app.getModuleName()+"&parent=Settings&view=Offline"},function(e,n){return!1})}),jQuery("#LicenseInfo").find("#checkkey").click(function(){var n=jQuery("#license_key");if(""==n.val()){var o=app.vtranslate(PVTErrors.EMPTYLICENSEKEY);return vtUtils.showValidationMessage(n,o,{position:{my:"top left",at:"bottom left"}}),e.reject(),e.promise()}var t=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),i={};i.module=app.getModuleName(),i.action="Activate",i.mode="activate",i.license=n.val(),AppConnector.request(i).then(function(e){if(t.progressIndicator({mode:"hide"}),e.success){var n=e.result.status,o=e.result.information;jQuery("#licenseinfo").html(o),"Ok"==n&&(jQuery("#license_key").prop("disabled",!0),jQuery("#valid").show(),jQuery("#inverse").show(),jQuery("#checkkey").hide(),jQuery("#licwarning").hide())}},function(e){console.log("error =",e),t.progressIndicator({mode:"hide"})})}),jQuery("#LicenseInfo").find("#valid").click(function(){var n=jQuery("#license_key");if(""==n.val()){var o=app.vtranslate(PVTErrors.EMPTYLICENSEKEY);return vtUtils.showValidationMessage(n,o,{position:{my:"top left",at:"bottom left"}}),e.reject(),e.promise()}var t=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),i={};i.module=app.getModuleName(),i.action="Activate",i.mode="showinformation",i.license=n.val(),AppConnector.request(i).then(function(e){if(t.progressIndicator({mode:"hide"}),e.success){var n=e.result.status,o=e.result.information;jQuery("#licenseinfo").html(o),"Ok"==n&&(jQuery("#license_key").prop("disabled",!0),jQuery("#valid").show(),jQuery("#inverse").show(),jQuery("#checkkey").hide(),jQuery("#licwarning").hide())}},function(e){console.log("error =",e),t.progressIndicator({mode:"hide"})})}),0!=$("#licensestatus").length){"Ok"!==jQuery("#licensestatus").val()&&$("#checkkey").trigger("click")}},registerValidEvent:function(){jQuery(".installationContents").find('[name="btnFinish"]').click(function(){var e=jQuery(".installationContents").find(".redirect").val(),n=jQuery.progressIndicator({position:"html",blockInfo:{enabled:!0}}),o={};o.module=app.getModuleName(),o.action="Activate",o.mode="valid",AppConnector.request(o).then(function(o){n.progressIndicator({mode:"hide"}),o.success&&(document.location.href=e)},function(e){console.log("error =",e),n.progressIndicator({mode:"hide"})})})},registerSaveEvent:function(){var e=this;jQuery("#downloadprekey").on("click",function(){var n=$("#licensekey").val();e.saveTextAsFile("prekey",n+".txt")}),jQuery("#downloadofflinekey").on("click",function(){$("#licensekey").val();e.saveTextAsFile("dofflinekey",app.getModuleName()+".offline")})},saveTextAsFile:function(e,n){var o=document.getElementById(e).innerHTML,t=new Blob([o],{type:"text/plain"}),i=n,r=document.createElement("a");r.download=i,r.innerHTML="Download File",null!==window.webkitURL?r.href=window.webkitURL.createObjectURL(t):(r.href=window.URL.createObjectURL(t),r.onclick=this.destroyClickedElement,r.style.display="none",document.body.appendChild(r)),r.click()},destroyClickedElement:function(e){document.body.removeChild(e.target)},registerEvents:function(){this.registerActivateLicenseEvent(),this.registerValidEvent(),this.recheckLicenseEvent(),this.registerInverseLicenseEvent(),this.registerReactivateLicenseEvent(),this.registerSaveEvent(),this.registerLicenseAgreementEvent(),vtUtils.enableTooltips()}}),jQuery(document).ready(function(){(new ParsVT_License_Js).registerEvents()});