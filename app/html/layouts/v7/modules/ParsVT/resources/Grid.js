/* ********************************************************************************
 * The content of this file is subject to the VTFarsi.ir Modules License("License");
 * You may not use this file except in compliance with the License
 * The Initial Developer of the Original Code is VTFarsi.ir
 * Portions created by VTFarsi.ir. are Copyright(C) VTFarsi Team
 * All Rights Reserved.
 * ****************************************************************************** */
Vtiger.Class("Vtiger_List_Js",{listInstance:!1,filterClick:!1,getInstance:function(){if(0==Vtiger_List_Js.listInstance){var e=app.getModuleName(),t=app.getParentModuleName();if("Settings"==t){var i=t+"_"+e+"_List_Js";void 0===window[i]&&(i=e+"_List_Js");var r=t+"_Vtiger_List_Js";void 0===window[r]&&(r="Vtiger_List_Js")}else i=e+"_List_Js",r="Vtiger_List_Js";if(void 0!==window[i])a=new window[i];else var a=new window[r];return Vtiger_List_Js.listInstance=a,a}return Vtiger_List_Js.listInstance},triggerMassEdit:function(e){var t=window.app.controller();if(t.getSelectedRecordCount()>500)app.helper.showErrorNotification({message:app.vtranslate("JS_MASS_EDIT_LIMIT")});else{app.event.trigger("post.listViewMassEdit.click",e);var i=t.getListSelectAllParams(!0);i?(app.helper.showProgress(),app.request.get({url:e,data:i}).then(function(e,t){app.helper.loadPageContentOverlay(t,{backdrop:"static",keyboard:!1}).then(function(e){app.event.trigger("post.listViewMassEdit.loaded",e)}),app.helper.hideProgress()})):t.noRecordSelectedAlert()}},triggerSendSms:function(e,t){var i=app.controller();1!=i.checkListRecordSelected()?(app.helper.showProgress(),app.helper.checkServerConfig(t).then(function(t){app.helper.hideProgress(),1==t?Vtiger_List_Js.triggerMassAction(e):app.helper.showAlertBox({message:app.vtranslate("JS_SMS_SERVER_CONFIGURATION")})})):i.noRecordSelectedAlert()},getListViewInstance:function(){return window.app.controller()},massDeleteRecords:function(e,t){app.controller().performMassDeleteRecords(e)},triggerExportAction:function(e){window.app.controller().performExportAction(e)},triggerSendEmail:function(e,t,i){var r=window.app.controller(),a=r.getListSelectAllParams(!1);if(a){var n=r.getDefaultParams();delete n.module,delete n.view,delete n.parent,jQuery.extend(n,a);var s=app.convertUrlToDataParams(e);jQuery.extend(n,s),i&&jQuery.extend(n,i),Vtiger_Index_Js.showComposeEmailPopup(n)}else r.noRecordSelectedAlert()},triggerTransferOwnership:function(e){var t=window.app.controller(),i=t.getListSelectAllParams();i?(app.helper.showProgress(),app.request.get({url:e,data:i}).then(function(e,i){if(app.helper.hideProgress(),i){var r={};r.cb=function(e){jQuery("#changeOwner").vtValidate({submitHandler:function(e){return t.transferOwnershipSave(jQuery(e)),!1}})},app.helper.showModal(i,r)}})):t.noRecordSelectedAlert()},triggerMassAction:function(e){var t=window.app.controller(),i=t.getListSelectAllParams(!0);if(i){var r=t.getDefaultParams();delete r.module,delete r.view,delete r.parent;var a=app.convertUrlToDataParams(e);r=jQuery.extend(r,a),r=jQuery.extend(r,i),app.helper.showProgress(),app.request.get({data:r}).then(function(e,t){app.helper.hideProgress(),t&&app.helper.showModal(t,{cb:function(e){if("showAddCommentForm"===r.mode){Vtiger_Index_Js.getInstance().registerMultiUpload()}app.event.trigger("post.listViewMassAction.loaded",e)}})})}else t.noRecordSelectedAlert()},showDuplicateSearchForm:function(e){app.helper.showProgress(),app.request.get({url:e}).then(function(e,t){t&&(app.helper.hideProgress(),app.helper.showModal(t,{cb:function(e){e.find("form").vtValidate({})}}))})},triggerMergeRecord:function(){window.app.controller().performMergeRecords()},triggerAddStar:function(){var e=app.controller();e.getListSelectAllParams(!0)?e.massStarSave({value:1}):e.noRecordSelectedAlert()},triggerRemoveStar:function(){var e=app.controller();e.getListSelectAllParams(!0)?e.massStarSave({value:0}):e.noRecordSelectedAlert()},triggerPreviewForRecord:function(e,t){return Vtiger_List_Js.getInstance().showQuickPreviewForId(e,t,""),!1},triggerAddTag:function(){var e=app.controller();(e=app.controller()).getListSelectAllParams(!0)?e.showAllTags(jQuery(".main-container")):e.noRecordSelectedAlert()},triggerRemoveTag:function(e){var t=app.controller();t.getListSelectAllParams(!0)?t.massRemoveTag(e):t.noRecordSelectedAlert()},previewFile:function(e,t,i){if(e.stopPropagation(),t){var r={module:"ModComments",view:"FilePreview",record:t,attachmentid:i};app.request.post({data:r}).then(function(e,t){app.helper.showModal(t),jQuery(".filePreview .preview-area").height(jQuery(window).height()-143)})}}},{listViewContainer:!1,_moduleName:!1,init:function(){this.addComponents()},addComponents:function(){this.addModuleSpecificComponent("CustomView"),this.addModuleSpecificComponent("ListSidebar"),this.addIndexComponent(),this.addComponent("Vtiger_MergeRecords_Js"),this.addModuleSpecificComponent("Pagination"),this.addComponent("Vtiger_Tag_Js")},addIndexComponent:function(){this.addModuleSpecificComponent("Index","Vtiger",app.getParentModuleName())},getListViewContainer:function(){return!1===this.listViewContainer&&(this.listViewContainer=jQuery("#listViewContent")),this.listViewContainer},setListViewContainer:function(e){return this.listViewContainer=e,this},recordSelectTrackerInstance:!1,getRecordSelectTrackerInstance:function(){return!1===this.recordSelectTrackerInstance?(this.recordSelectTrackerInstance=Vtiger_GridRecordSelectTracker_Js.getInstance(),this.recordSelectTrackerInstance.setCvId(this.getCurrentCvId())):this.recordSelectTrackerInstance.setCvId(this.getCurrentCvId()),this.recordSelectTrackerInstance},getCurrentCvId:function(){return this.getListViewContainer().find('[name="cvid"]').val()},getModuleName:function(){return 0!=this._moduleName?this._moduleName:app.module()},setModuleName:function(e){return this._moduleName=e,this},noRecordSelectedAlert:function(){return app.helper.showAlertBox({message:app.vtranslate("JS_PLEASE_SELECT_ONE_RECORD")})},registerRemoveListViewSort:function(){var e=this;this.getListViewContainer().on("click",".removeSorting",function(t){var i=e.getCurrentCvId();e.loadFilter(i,{mode:"removeSorting"})})},performMassDeleteRecords:function(e){for(var t=this,i={},r=e.slice(e.indexOf("?")+1).split("&"),a=0;a<r.length;a++){var n=r[a].split("=");i[n[0]]=n[1]}var s=t.getListSelectAllParams(!0);if(s=jQuery.extend(s,i)){var o=app.vtranslate("LBL_MASS_DELETE_CONFIRMATION");app.helper.showConfirmationBox({message:o}).then(function(e){s.module=app.getModuleName(),s.action="MassDelete",s.search_params=JSON.stringify(t.getListSearchParams()),app.helper.showProgress(),app.request.post({data:s}).then(function(e,i){app.helper.hideProgress(),e?app.helper.showErrorNotification():(t.clearList(),t.getPageCount().then(function(e){var i=parseInt(e.page),r=t.getListViewContainer().find("#pageNumber"),a={};parseInt(r.val())>i&&(a={page:1}),t.loadListViewRecords(a)}))})})}else t.noRecordSelectedAlert()},performExportAction:function(e){this.getListViewContainer().find("#pageNumber").val();var t=this.getDefaultParams(),i=app.convertUrlToDataParams(e);t=jQuery.extend(t,i);var r=this.getListSelectAllParams(!0);r.search_params=JSON.stringify(this.getListSearchParams()),t=jQuery.extend(t,r),app.helper.showProgress(),app.request.get({data:t}).then(function(e,t){app.helper.loadPageContentOverlay(t).then(function(e){e.find("form#exportForm").on("submit",function(){jQuery(this).find('button[type="submit"]').attr("disabled","disabled"),app.helper.hidePageContentOverlay()})}),app.helper.hideProgress()})},registerListViewSort:function(){var e=this.getListViewContainer(),t=this;e.on("click",".listViewContentHeaderValues",function(i){var r=jQuery(i.currentTarget).data("columnname"),a=jQuery(i.currentTarget).data("nextsortorderval");"ASC"===a?jQuery("i",i.currentTarget).addClass("fa-sort-asc"):jQuery("i",i.currentTarget).addClass("fa-sort-desc"),e.find('[name="sortOrder"]').val(a),e.find('[name="orderBy"]').val(r);t.getCurrentCvId();t.loadListViewRecords()})},resetData:function(){var e=this.getListViewContainer();e.find("#pageNumber").val("1"),e.find("#pageToJump").val("1"),e.find("#orderBy").val(""),e.find("#sortOrder").val(""),e.find("#currentSearchParams").val(JSON.stringify(new Array)),e.find("#currentTagParams").val(JSON.stringify(new Array)),e.find('[name="tag"]').val(""),e.find('[name="list_headers"]').val("");this.getRecordSelectTrackerInstance().clearList()},loadFilter:function(e,t){void 0===t&&(t={});var i={module:this.getModuleName(),view:app.view(),viewname:e};i=jQuery.extend(i,t),this.loadListViewRecords(i)},loadListViewRecords:function(e){var t=this,i=jQuery.Deferred(),r=this.getDefaultParams();return void 0===e&&(e={}),void 0===e.search_params&&(e.search_params=JSON.stringify(this.getListSearchParams(!1))),e=jQuery.extend(r,e),app.helper.showProgress(),"ListAjax"==e.view?app.request.post({data:e}).then(function(e,r){i.resolve(r),t.postLoadListViewRecords(r)}):app.request.pjax({data:e}).then(function(e,r){i.resolve(r),t.postLoadListViewRecords(r)}),i.promise()},postLoadListViewRecords:function(e){this.placeListContents(e),app.event.trigger("post.listViewFilter.click",jQuery(".searchRow")),app.helper.hideProgress(),this.markSelectedIdsCheckboxes(),this.registerDynamicListHeaders(),this.registerPostLoadListViewActions()},placeListContents:function(e){this.getListViewContainer().html(e)},getDefaultParams:function(){var e=this.getListViewContainer(),t=e.find("#pageNumber").val(),i={module:this.getModuleName(),parent:app.getParentModuleName(),page:t,view:"Grid",viewname:this.getCurrentCvId(),orderby:e.find('[name="orderBy"]').val(),sortorder:e.find('[name="sortOrder"]').val(),app:e.find("#appName").val()};return i.search_params=JSON.stringify(this.getListSearchParams()),i.tag_params=JSON.stringify(this.getListTagParams()),i.nolistcache=1==e.find("#noFilterCache").val()?1:0,i.starFilterMode=e.find(".starFilter li.active a").data("type"),i.list_headers=e.find('[name="list_headers"]').val(),i.tag=e.find('[name="tag"]').val(),i},getListTagParams:function(){var e=this.getListViewContainer(),t=new Array,i=new Array;e.find("#currentTagParams").val()&&(t=JSON.parse(e.find("#currentTagParams").val()));for(var r in t){var a=t[r].fieldName,n=t[r].searchValue,s=t[r].comparator;if(!(null==a||a.length<=0)){var o=new Array;o.push(a),o.push(s),o.push(n),i.push(o)}}if(i.length>0)l=new Array(i);else var l=new Array;return l},isInteger:function(e){return!isNaN(e)},getListSearchParams:function(e){void 0===e&&(e=!0);var t=this.getListViewContainer(),i=t.find(".searchRow"),r=new Array,a=new Array;if(t.find("#currentSearchParams").val()&&(a=JSON.parse(t.find("#currentSearchParams").val())),!this.filterClick){i.find(".listSearchContributor").each(function(e,t){var i=new Array,n=jQuery(t),s=n.attr("name"),o=uimeta.field.get(s);void 0===o&&(o=n.data("fieldinfo")),null!=a&&(void 0!==s&&s in a&&delete a[s],"starred"in a&&delete a.starred);var l=n.val();if("object"==typeof l&&(l=null==l?"":l.join(",")),(l=l.trim()).length<=0)return!0;var d="c";"date"==o.type||"datetime"==o.type?d="bw":"percentage"!=o.type&&"double"!=o.type&&"integer"!=o.type&&"currency"!=o.type&&"number"!=o.type&&"boolean"!=o.type&&"picklist"!=o.type||(d="e");var c=n.parent().parent().find(".operatorValue").val();c&&(d=c,c=!1),i.push(s),i.push(d),i.push(l),r.push(i)});for(var n in a)if(this.isInteger(parseInt(n))){var s=a[n].fieldName,o=a[n].searchValue,l=a[n].comparator;if(!(null==s||s.length<=0)){var d=new Array;d.push(s),d.push(l),d.push(o),r.push(d)}}if(r.length>0)c=new Array(r);else var c=new Array;return e&&(c=this.addStarSearchParams(c)),c}},addStarSearchParams:function(e){var t=this.getListViewContainer().find(".starFilter li.active").find("a").data("type");if("starred"==t){void 0===e[0]&&(e[0]=new Array);var i=new Array;i.push("starred"),i.push("e"),i.push("1"),e[0].push(i)}else if("unstarred"==t){void 0===e[0]&&(e[0]=new Array);var r=new Array;r.push("starred"),r.push("e"),r.push("0"),e[0].push(r)}return e},pageJump:function(){var e,t=this.getListViewContainer(),i=t.find("#totalPageCount");if(""===i.text()){var r=t.find("#totalCount"),a=r.val();if(""!==a){var n=t.find("#pageLimit").val();return"0"===n&&(n=1),0===(e=Math.ceil(a/n))&&(e=1),void i.text(e)}this.getPageCount().then(function(e){var t=e.page;r.val(e.numberOfRecords),0===t&&(t=1),i.text(t)})}},pageJumpOnSubmit:function(e){var t=this.getListViewContainer(),i=t.find("#pageNumber"),r=parseInt(i.val()),a=parseInt(t.find("#pageToJump").val());if(a>parseInt(t.find("#totalPageCount").text())){s=app.vtranslate("JS_PAGE_NOT_EXIST");app.helper.showErrorNotification({message:s})}else if(a!==r){var n=this.getPagingParams();n.page=a,this.loadListViewRecords(n).then(function(t){e.closest(".btn-group ").removeClass("open")})}else{var s=app.vtranslate("JS_YOU_ARE_IN_PAGE_NUMBER")+" "+a;app.helper.showAlertNotification({message:s})}},registerInlineEdit:function(e){e.addClass("edited");var t=jQuery(".listViewEntryValue",e);e.addClass("edited"),jQuery(".action",e).addClass("hide"),jQuery(".inline-save",e).removeClass("hide");for(var i=0;i<t.length;i++){var r=[],a=jQuery(t[i]),n=jQuery(".edit",a),s=jQuery(".fieldValue",a),o=this.getModuleName(),l=a.data("name");if(!l.match(/\((\w+)\s\;\s\((\w+)\)\s(\w+)\)/g)||!l.match(/\((\w+)\s\;\s\((\w+)\)\s(\w+)\)/g).length){var d=a.data("field-type"),c=new Array;"undefined"!=typeof uimeta&&(c=uimeta.field.get(l)),(void 0===c||c.length<=0)&&"undefined"!=typeof adv_search_uimeta&&(c=adv_search_uimeta.field.get(l));var u=jQuery.trim(s.text());if(-1!==jQuery.inArray(d,["owner","ownergroup","picklist","multipicklist","reference","string","url","currency","text","email","boolean"])&&(u=a.data("rawvalue")),r.value=u,jQuery.extend(r,c),!(n.length<=0||n.is(":visible"))){var p=new Vtiger_Field_Js.getInstance(r,o).getUiTypeModel();0===jQuery("input",n).length&&n.append(p.getUi()),"reference"===d&&0!==u&&jQuery('input[name="'+l+'"]',n).prop("value",jQuery.trim(s.text())),s.addClass("hide"),n.removeClass("hide"),"picklist"===d&&this.registerEventForPicklistDependencySetup(e)}}}app.event.trigger("post.listViewInlineEdit.click",e)},registerEventForPicklistDependencySetup:function(e){var t=jQuery('[name="picklistDependency"]');if(!(t.length<=0)){var i=JSON.parse(t.val()),r=Object.keys(i);if(!(r.length<=0)){for(var a="",n=0;n<r.length;n++)n!=r.length-1?a+='[name="'+r[n]+'"],':a+='[name="'+r[n]+'"]';var s=e.find(a);s.on("change",function(t){var r=jQuery(t.currentTarget),a=r.attr("name"),n=i[a],s=n[r.val()],o=n.__DEFAULT__;void 0===s&&(s=o),jQuery.each(o,function(t,i){var a=s[t];void 0===a&&(a=i);var n=jQuery('[name="'+t+'"]',e);if(!(n.length<=0)){var o=n.data("availableOptions");void 0===o&&(o=jQuery("option",n),n.data("available-options",o));var l=new jQuery,d=[];d.push("");for(var c=0;c<a.length;c++)d.push(a[c]);jQuery.each(o,function(e,t){var i=jQuery(t).val();-1!=jQuery.inArray(i,d)&&(l=l.add(jQuery(t)))});var u="",u=l.filter("[selected]").val();if(1==a.length)u=a[0];if(("group_id"==t||"assigned_user_id"==t)&&""==r.val())return!1;n.html(l).val(u).trigger("change")}})}),s.trigger("change")}}},validateAndSaveInlineEdit:function(e){for(var t=this.getListViewContainer(),i=this,r=jQuery(".listViewEntryValue",e),a=e.data("id"),n={},s=0;s<r.length;s++){var o=jQuery(r[s]),l=jQuery(".inputElement",o),d=o.data("name");n[d]=i.getInlineEditedFieldValue(o,l)}var c={ignore:".listSearchContributor,input[type='hidden']",submitHandler:function(t){if(this.numberOfInvalids()>0)return this.form(),!1;var r={module:i.getModuleName(),action:"SaveAjax",record:a},r=jQuery.extend(n,r);return app.helper.showProgress(),jQuery(".inline-save",e).find("button").attr("disabled","disabled"),app.request.post({data:r}).then(function(t,r){if(!r)return app.helper.hideProgress(),app.event.trigger("post.save.failed",t),jQuery(".inline-save",e).find("button").removeAttr("disabled"),!1;jQuery(".vt-notification").remove(),jQuery(".inline-save",e).find("button").removeAttr("disabled");i.loadListViewRecords({}).then(function(t){i.toggleInlineEdit(e),app.helper.hideProgress(),app.helper.showSuccessNotification({message:""}),app.event.trigger("onclick.referenceField.quickPreview",e)})}),!1}};validateAndSubmitForm(t.find("#listedit"),c)},registerInlineEditSaveEvent:function(){var e=this;this.getListViewContainer().on("click",".save",function(t){t.preventDefault();var i=jQuery(t.currentTarget).closest("tr");e.validateAndSaveInlineEdit(i)})},registerInlineEditCancelEvent:function(){var e=this;this.getListViewContainer().on("click",".cancel",function(t){t.preventDefault();var i=jQuery(t.currentTarget).closest("tr");e.toggleInlineEdit(i),i.removeClass("edited");var r=jQuery("#listview-table").closest(".table-container");r.height(r.height()+1e3-28),r.perfectScrollbar("update")})},getInlineEditedFieldValue:function(e,t){var i=null,r=e.data("field-type");if(-1!==jQuery.inArray(r,["owner","picklist","ownergroup","currencyList"]))i=jQuery(".inputElement.select2",e).find(":selected").val();else if("reference"===r)i=t.data("value");else if("multipicklist"===r){var a=jQuery(".inputElement.select2",e).find(":selected");i=[];for(var n=0;n<a.length;n++){var s=jQuery(a.get(n));i.push(s.val())}}else i="boolean"==r?e.find("input:checkbox").is(":checked")?1:0:t.val();return i},toggleInlineEdit:function(e){jQuery(".inline-save",e).addClass("hide"),jQuery(".action",e).removeClass("hide"),jQuery(".edit",e).empty(),jQuery(".edit",e).addClass("hide"),jQuery(".fieldValue",e).removeClass("hide"),e.removeClass("edited")},searchModuleNames:function(e){var t=jQuery.Deferred();if(void 0===e.module&&(e.module=this.getModuleName()),void 0===e.action&&(e.action="BasicAjax"),void 0===e.base_record){var i=jQuery('[name="record"]'),r=app.getRecordId();if(i.length)e.base_record=i.val();else if(r)e.base_record=r;else if("List"==app.view()){var a=jQuery("#listview-table").find("div.gridViewEntries.edited").data("id");a&&(e.base_record=a)}}return app.request.get({data:e}).then(function(e,i){t.resolve(i)},function(e){t.reject()}),t.promise()},getReferenceSearchParams:function(e){var t=jQuery(e).closest("td"),i={},r=(jQuery('input[name="referenceModule"]',t).length?jQuery('input[name="referenceModule"]',t):jQuery("input.referenceModule",t)).val();return i.search_module=r,i},registerRowClickEvent:function(){var e=this.getListViewContainer();e.on("click",".listViewEntries a",function(e){var t=jQuery(e.currentTarget),i=t.attr("href");jQuery(e.target).hasClass("js-reference-display-value")||(t.data("timer")||void 0===i||t.data("timer",setTimeout(function(){window.location=i},500)),e.preventDefault()),e.stopPropagation()}),e.on("click",".listViewEntries",function(e){jQuery(e.target).hasClass("js-reference-display-value")||setTimeout(function(){if(0===jQuery(".listViewEntries.edited").length){if(0==window.getSelection().toString().length){var t=jQuery(e.target,jQuery(e.currentTarget));if(t.closest("td").is("td:first-child"))return;if(t.closest("tr").hasClass("edited"))return;if(jQuery(e.target).is('input[type="checkbox"]'))return;var i=jQuery(e.currentTarget).data("recordurl");if(void 0===i)return;window.location.href=i}}},300)})},registerRowDoubleClickEvent:function(){var e=this,t=this.getListViewContainer();t.on("dblclick",".listViewEntries",function(i){if("no"!=t.find("#isExcelEditSupported").val()){(r=jQuery(i.currentTarget)).find("a").each(function(e,t){jQuery(t).data("timer")&&(clearTimeout(jQuery(t).data("timer")),jQuery(t).data("timer",null))});if(0===jQuery(".listViewEntries.edited").length){var r=jQuery(i.currentTarget),a=jQuery(i.target,jQuery(i.currentTarget));if(a.closest("td").is("td:first-child"))return;if(a.closest("tr").hasClass("edited"))return;e.registerInlineEdit(r)}}})},registerFieldActionEvents:function(e){var t=Vtiger_Index_Js.getInstance();t.registerAutoCompleteFields(e),t.registerClearReferenceSelectionEvent(e),t.referenceModulePopupRegisterEvent(e)},registerInlineSaveOnEnterEvent:function(e){e.find(".inputElement:not(textarea)").on("keyup",function(t){var i=jQuery(t.target).closest(".listViewEntryValue").data("fieldType");-1===["reference","picklist","multipicklist","owner"].indexOf(i)&&13===(t.keyCode||t.which)&&e.find("button.save").trigger("click")})},registerListViewBasicActions:function(){var e=this;this.getListViewContainer().on("click",".table-actions .inlineEdit",function(t){if(0===jQuery(".listViewEntries.edited").length){var i=jQuery(t.currentTarget).parents("tr");e.registerInlineEdit(i)}}),this.registerInlineEditSaveEvent(),this.registerInlineEditCancelEvent(),app.event.on("post.listViewInlineEdit.click",function(t,i){vtUtils.applyFieldElementsView(i),e.registerFieldActionEvents(i);var r=jQuery("#listview-table").closest(".table-container");r.height(r.height()+1e3+28),r.perfectScrollbar("update"),e.registerInlineSaveOnEnterEvent(i)});var t=!1;app.event.on("post.listViewMassEdit.loaded",function(i,r){app.event.trigger("post.listViewInlineEdit.click",r);var a=r.find(".modal-body .datacontent").offset(),n={setHeight:$(window).height()+1e3-60-a.top+"px"};r.find('[name="assigned_user_id"]').on("click",function(){t=!0}),app.helper.showVerticalScroll(r.find(".modal-body .datacontent"),n);Vtiger_Edit_Js.getInstance().registerBasicEvents(r);var s=$("#massEdit").serialize();$("#massEdit").on("submit",function(i){e.saveMassEdit(i,s,t),t=!1}),e.registerAutoIncludeFieldsInMassEdit(),app.helper.registerLeavePageWithoutSubmit($("#massEdit")),app.helper.registerModalDismissWithoutSubmit($("#massEdit"))}),app.event.on("post.listViewMassAction.loaded",function(e,t){jQuery("#phoneFormatWarningPop").popover(),jQuery("#massSave").vtValidate({ignore:"input[type='file'].multi",submitHandler:function(e){var t=jQuery(e),i=jQuery(e).serializeFormData(),i=new FormData(t[0]);Vtiger_Index_Js.files&&(i.append("filename",Vtiger_Index_Js.files),delete Vtiger_Index_Js.files);var r={url:"index.php",type:"POST",data:i,processData:!1,contentType:!1};return app.helper.showProgress(),app.request.post(r).then(function(t,i){if(app.helper.hideProgress(),app.helper.hideModal(),"SMSNotifier"==jQuery(e).find('[name="module"]').val()){var r=i.statusdetails,a=r.status;if("Failed"==a){var n=r.statusmessage+"<br>"+app.vtranslate("JS_PHONEFORMAT_ERROR");app.helper.showErrorNotification({title:a,message:n})}else{var s=r.statusmessage;app.helper.showSuccessNotification({title:a,message:s})}}app.event.trigger("post.listViewMassEditSave")}),!1}})})},prevSearchValues:[],registerListViewSearch:function(){var e=this.getListViewContainer(),t=this;e.on("click",'[data-trigger="listSearch"]',function(i){i.preventDefault();jQuery(this).addClass("hide"),e.find('[data-trigger="clearListSearch"]').removeClass("hide"),t.loadListViewRecords({page:"1"}).then(function(e){jQuery("#deSelectAllMsgDiv").trigger("click")},function(e,t){})});e.on("click",'[data-trigger="clearListSearch"]',function(i){i.preventDefault(),e.find('.listSearchContributor:not(".select2-container")').each(function(e,t){!function(e){e.is("input")?e.val(""):e.is("select")?(e.select2("val",""),e.val("")):console.log("contributor clearing now handled : ",e)}(t=jQuery(t))});jQuery(this).addClass("hide"),t.prevSearchValues=[],jQuery("#currentSearchParams").val(""),e.find('[data-trigger="listSearch"]').removeClass("hide").trigger("click")});var i=function(i){var r=jQuery(i.currentTarget),a=r.attr("name"),n=r.val();if(r.hasClass("select2")){var s=r.closest(".select2_search_div").find("div.listSearchContributor").find("ul");s.height()>150?s.css({cssText:"height:150px !important;padding:0"}):s.find(".mCSB_container").height()<150&&s.removeAttr("style"),s.mCustomScrollbar("update")}if(13==i.keyCode&&t.prevSearchValues[a]!==n&&!r.hasClass("select2")){i.preventDefault();(r=jQuery(i.currentTarget)).closest("tr").find('[data-trigger="listSearch"]').trigger("click"),t.prevSearchValues[a]=n}13!==i.keyCode&&(e.find('[data-trigger="clearListSearch"]').addClass("hide"),setTimeout(function(){e.find('[data-trigger="listSearch"]').removeClass("hide")},10))};e.find(".searchRow div.listSearchContributor.select2").each(function(e,t){var i=jQuery(t);app.helper.showVerticalScroll(i.find("ul"),{height:150})}),e.on("keyup",".listSearchContributor",i),e.on("change","select",i),e.on("datepicker-change",".dateField",function(e){jQuery(e.currentTarget).trigger("change"),i(e)})},registerAutoIncludeFieldsInMassEdit:function(){var e=function(){var e=$(this).attr("name");e=e.replace(/\[\]$/,""),$(this).closest("tr").find("input[id=include_in_mass_edit_"+e+"]").prop("checked",!0)},t=jQuery("#massEdit :input").not("[id^=include_in_mass_edit_]");t.on(Vtiger_Edit_Js.referenceSelectionEvent,e),t.change(e)},saveMassEdit:function(e){e.preventDefault();var t=$("#massEdit"),i=t.find("input[id^=include_in_mass_edit_]:checked");if(app.helper.showProgress(),i.length>0){var r=app.convertUrlToDataParams(t.serialize()),a="";t.children("input[type=hidden]").each(function(e,t){key=$(this).attr("name"),void 0!==r[key]&&(a+=key+"="+r[key]+"&")}),i.each(function(e,t){var i=$(this).data("update-field"),n=i+encodeURI("[]"),s=i;void 0!==r[n]&&(s=n);var o=r[s];a+=s+"=",void 0!==o&&(a+=o),a+="&"}),app.request.post({data:a}).then(function(e,t){app.helper.hideProgress(),t?(jQuery(".vt-notification").remove(),app.helper.hidePageContentOverlay(),window.onbeforeunload=null,app.event.trigger("post.listViewMassEditSave")):app.event.trigger("post.save.failed",e)})}else app.helper.hideProgress(),app.helper.showAlertBox({message:app.vtranslate("NONE_OF_THE_FIELD_VALUES_ARE_CHANGED_IN_MASS_EDIT")})},markSelectedIdsCheckboxes:function(){var e=this.getRecordSelectTrackerInstance(),t=e.getSelectAllMode(),i=e.getExcludedIds(),r=this.checkIdsAreEmpty(i),a=e.getSelectedIds(),n=(this.getCurrentCvId(),e.getCvid(),jQuery("div.gridViewEntries"));if(1==t)jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").addClass("show"),this.isStarFilterMode()?n=this.getStarRecordRows():this.isUnStarFilterMode()&&(n=this.getUnStarRecordRows()),r?n.each(function(e,t){jQuery(t).find(".listViewEntriesCheckBox").prop("checked",!0)}):n.each(function(e,t){var r=$(t).data("id");jQuery(t).find(".listViewEntriesCheckBox").prop("checked",!0);for(var a=0;a<i.length;a++){var n=i[a];n==r&&(jQuery('.listViewEntriesCheckBox[value="'+n+'"]').prop("checked",!1),jQuery(".listViewEntriesMainCheckBox").prop("checked",!1))}});else{if(!this.checkIdsAreEmpty(a)){n.each(function(e,t){for(var i=$(t).data("id"),r=0;r<a.length;r++){var n=a[r];n==i&&jQuery('.listViewEntriesCheckBox[value="'+n+'"]').prop("checked",!0)}});var s=this.getListViewContainer();0==s.find(".listViewEntriesCheckBox").not(":checked").length?s.find(".listViewEntriesMainCheckBox").prop("checked",!0):s.find(".listViewEntriesMainCheckBox").prop("checked",!1)}}},checkIdsAreEmpty:function(e){return void 0==e||null==e||e.length<=0},performMergeRecords:function(){var e=this,t=e.readSelectedIds();t.length>3?app.helper.showErrorNotification({message:app.vtranslate("JS_ALLOWED_TO_SELECT_MAX_OF_THREE_RECORDS")}):t.length<2?app.helper.showErrorNotification({message:app.vtranslate("JS_SELECT_ATLEAST_TWO_RECORD_FOR_MERGING")}):(app.event.trigger("Request.MergeRecords.show",{records:t}),app.event.one("post.MergeRecords",function(t){e.clearList(),e.loadListViewRecords()}))},clearList:function(){this.getRecordSelectTrackerInstance().clearList()},getListSelectAllParams:function(e){var t=this.getRecordSelectTrackerInstance().getSelectedAndExcludedIds(e);t.search_params=JSON.stringify(this.getListSearchParams());var i=this.getListViewContainer();return t.tag_params=JSON.stringify(this.getListTagParams()),t.tag=i.find('[name="tag"]').val(),t},registerCheckBoxClickEvent:function(){var e=this,t=e.getListViewContainer(),i=e.getRecordSelectTrackerInstance();t.on("click",".listViewEntriesCheckBox",function(r){var a=t.find(r.currentTarget),n=a.closest(".listViewEntries");if(a.is(":checked")){if(n.trigger("Post.ListRow.Checked",{id:n.data("id")}),e.registerPostLoadListViewActions(),i.selectAllMode){var s=i.getExcludedIds();e.checkIdsAreEmpty(s)&&t.find(".listViewEntriesMainCheckBox").prop("checked",!0)}}else n.trigger("Post.ListRow.UnChecked",{id:n.data("id")}),e.registerPostLoadListViewActions(),i.selectAllMode&&t.find(".listViewEntriesMainCheckBox").prop("checked",!1);0==t.find(".listViewEntriesCheckBox").not(":checked").length?t.find(".listViewEntriesMainCheckBox").prop("checked",!0):t.find(".listViewEntriesMainCheckBox").prop("checked",!1)})},readSelectedIds:function(e){var t=this.getRecordSelectTrackerInstance().getSelectedIds();return e&&"object"==typeof t?JSON.stringify(t):t},readExcludedIds:function(e){var t=this.getRecordSelectTrackerInstance().getExcludedIds();return e?JSON.stringify(t):t},getSelectAllMode:function(){return this.getRecordSelectTrackerInstance().getSelectAllMode()},showSelectAllMsgDiv:function(){jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").removeClass("show"),jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").addClass("hide"),jQuery("#selectAllMsgDiv").closest("div.messageContainer").addClass("show")},showDeSelectAllMsgDiv:function(){jQuery("#selectAllMsgDiv").closest("div.messageContainer").removeClass("show"),jQuery("#selectAllMsgDiv").closest("div.messageContainer").addClass("hide"),jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").addClass("show")},deSelectAllWithNoMessage:function(){jQuery("#selectAllMsgDiv").closest("div.messageContainer").removeClass("show"),jQuery("#selectAllMsgDiv").closest("div.messageContainer").addClass("hide"),jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").removeClass("show"),jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").addClass("hide")},showSelectAll:function(){var e=this;app.helper.showProgress(),e.getRecordsCount().then(function(t){e.showSelectAllMsgDiv(),jQuery("#totalRecordsCount").text(t.count),app.helper.hideProgress()})},registerListViewMainCheckBoxClickEvent:function(){var e=this,t=this.getListViewContainer();t.on("click",".listViewEntriesMainCheckBox",function(i){i.stopPropagation();if(jQuery(i.currentTarget).is(":checked")){var r=t.find("div.gridViewEntries");e.isStarFilterMode()?r=e.getStarRecordRows():e.isUnStarFilterMode()&&(r=e.getUnStarRecordRows()),r.find(".listViewEntriesCheckBox").each(function(t){jQuery(this).prop("checked",!0);var i=jQuery(this).closest(".listViewEntries");i.trigger("Post.ListRow.Checked",{id:i.data("id")}),e.registerPostLoadListViewActions()}),1==e.getSelectAllMode()?e.markSelectedIdsCheckboxes():e.showSelectAll()}else 1==e.getSelectAllMode()?e.showDeSelectAllMsgDiv():e.deSelectAllWithNoMessage(),jQuery(".listViewEntriesCheckBox").each(function(t){jQuery(this).prop("checked",!1);var i=jQuery(this).closest(".listViewEntries");i.trigger("Post.ListRow.UnChecked",{id:i.data("id")}),e.registerPostLoadListViewActions()})})},registerSelectAllClickEvent:function(){var e=this,t=this.getListViewContainer();t.on("click","#selectAllMsgDiv",function(i){e.showDeSelectAllMsgDiv();var r=e.getCurrentCvId();t.trigger("Post.ListSelectAll",{mode:!0,cvId:r})}),e.markSelectedIdsCheckboxes()},registerDeSelectAllClickEvent:function(){var e=this,t=this.getListViewContainer();t.on("click","#deSelectAllMsgDiv",function(i){jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").removeClass("show"),jQuery("#deSelectAllMsgDiv").closest("div.messageContainer").addClass("hide"),t.trigger("Post.ListDeSelectAll",{mode:!1}),e.registerPostLoadListViewActions(),jQuery(".listViewEntriesMainCheckBox").prop("checked",!1),jQuery(".listViewEntriesCheckBox").each(function(e){jQuery(this).prop("checked",!1)})})},getRecordsCount:function(){var e=jQuery.Deferred(),t=this.getCurrentCvId(),i=this.getModuleName(),r=app.getParentModuleName(),a=this.getDefaultParams(),n={module:i,parent:r,view:"ListAjax",viewname:t,mode:"getRecordsCount"};n=jQuery.extend(a,n);var s={};return s.data=n,app.request.get(s).then(function(t,i){e.resolve(i)}),e.promise()},transferOwnershipSave:function(e){var t=window.app.controller(),i=t.getListSelectAllParams(!1);if(i){var r=e.serializeFormData(),a=jQuery.extend(r,i);app.helper.showProgress(),app.request.post({data:a}).then(function(i,r){app.helper.hideProgress(),null==i?(jQuery(".vt-notification").remove(),app.helper.hideModal(),t.loadListViewRecords().then(function(e){t.clearList(),app.helper.showSuccessNotification({message:app.vtranslate("JS_RECORDS_TRANSFERRED_SUCCESSFULLY")})})):(app.event.trigger("post.save.failed",i),jQuery(e).find("button[name='saveButton']").removeAttr("disabled"))})}},registerStarToggle:function(){var e=this;this.getListViewContainer().on("click",".markStar",function(t){var i=jQuery(t.currentTarget);if(!i.hasClass("processing")){i.addClass("processing");var r=i.closest("div.gridViewEntries").data("id"),a={};a.module=e.getModuleName(),a.action="SaveStar",a.record=r,i.hasClass("active")?(a.value=0,i.removeClass("fa-star").addClass("fa-star-o")):(a.value=1,i.removeClass("fa-star-o").addClass("fa-star")),i.toggleClass("active"),a._timeStampNoChangeMode=!0,app.request.post({data:a}).then(function(e,t){t&&(0==a.value?i.attr("title",app.vtranslate("JS_NOT_STARRED")):i.attr("title",app.vtranslate("JS_STARRED"))),i.removeClass("processing")}),i.hasClass("active")?app.helper.showSuccessNotification({message:app.vtranslate("JS_FOLLOW_RECORD")}):app.helper.showSuccessNotification({message:app.vtranslate("JS_UNFOLLOW_RECORD")})}})},massStarSave:function(e){var t=this,i=window.app.controller().getSelectedRecordCount();e.module=this.getModuleName(),e.action="SaveStar";var r=this.getCurrentCvId();e.viewname=r,e.search_params=JSON.stringify(t.getListSearchParams()),(e=jQuery.extend(e,t.getListSelectAllParams(!1)))._timeStampNoChangeMode=!0,app.helper.showProgress(),app.request.post({data:e}).then(function(r,a){app.helper.hideProgress(),t.loadListViewRecords().then(function(r){t.clearList(),1==e.value?app.helper.showSuccessNotification({message:app.vtranslate("JS_FOLLOWING")+" "+i+" "+app.vtranslate(e.module)}):app.helper.showSuccessNotification({message:app.vtranslate("JS_UNFOLLOWING")+" "+i+" "+app.vtranslate(e.module)})})})},getStarRecordRows:function(){return this.getListViewContainer().find("div.gridViewEntries .markStar.fa-star .active").closest("tr")},getUnStarRecordRows:function(){return this.getListViewContainer().find("div.gridViewEntries .markStar .fa-star-o").closest("tr")},isStarFilterMode:function(){return"starred"==jQuery(".starFilter li.active").find("a").data("type")},isUnStarFilterMode:function(){return"unstarred"==jQuery(".starFilter li.active").find("a").data("type")},selectRecordsDependingOnStarFilter:function(){this.isStarFilterMode()?this.getStarRecordRows().find(".listViewEntriesCheckBox").trigger("click"):this.isUnStarFilterMode()?this.getUnStarRecordRows().find(".listViewEntriesCheckBox").trigger("click"):jQuery("div.gridViewEntries").find(".listViewEntriesCheckBox").trigger("click")},registerStarUnstarFilter:function(){var e=this;this.getListViewContainer().on("click",".starFilter li",function(t){var i=jQuery(t.currentTarget);jQuery(".starFilter li").removeClass("active"),i.addClass("active"),jQuery("div.gridViewEntries").find(".listViewEntriesCheckBox").prop("checked",!1),e.clearList(),e.selectRecordsDependingOnStarFilter(),e.showSelectAll()})},getPageJumpParams:function(){var e=this.getDefaultParams();return e.view="ListAjax",e.mode="getPageCount",e},getPagingParams:function(){return{orderby:jQuery("#orderBy").val(),sortorder:jQuery("#sortOrder").val(),viewname:this.getCurrentCvId()}},getPageCount:function(){var e=jQuery.Deferred(),t={type:"GET",data:this.getPageJumpParams()};return app.request.get(t).then(function(t,i){var r;r="object"!=typeof i?JSON.parse(i):i,e.resolve(r)}),e.promise()},registerDeleteRecordClickEvent:function(){var e=this;jQuery("#page").on("click",".deleteRecordButton",function(t){var i=jQuery(t.currentTarget),r=i,a={},n=i.closest(".dropdown-menu").data("original-menu");if(n&&void 0!==n){r=app.helper.getDropDownmenuParent(n);var s=jQuery("#searchModuleList").val();s&&void 0!==s&&(a.module=s)}var o=r.closest("tr").data("id");e.deleteRecord(o,a)})},_deleteRecord:function(e,t){var i=this,r={data:{module:app.getModuleName(),action:"DeleteAjax",record:e,parent:app.getParentModuleName(),viewname:this.getCurrentCvId()}};void 0===t&&(t={}),jQuery.extend(r.data,t),app.helper.showProgress(),app.request.post(r).then(function(e,t){null==e?(app.helper.hideProgress(),i.loadListViewRecords()):(app.helper.hideProgress(),app.helper.showErrorNotification({message:app.vtranslate(e.message)}))})},deleteRecord:function(e,t){var i=this,r=app.vtranslate("LBL_DELETE_CONFIRMATION");app.helper.showConfirmationBox({message:r}).then(function(){i._deleteRecord(e,t)})},totalNumOfRecords_performingAsyncAction:!1,totalNumOfRecords:function(e){var t=this,i=t.getListViewContainer(),r=i.find("#totalCount"),a=r.val();t.totalNumOfRecords_performingAsyncAction||(e.find(".showTotalCountIcon").addClass("hide"),""===a?(t.totalNumOfRecords_performingAsyncAction=!0,t.getPageCount().then(function(n){e.addClass("hide"),a=n.numberOfRecords,r.val(a),i.find("ul#listViewPageJumpDropDown #totalPageCount").text(n.page),t.showPagingInfo(),t.totalNumOfRecords_performingAsyncAction=!1})):(e.addClass("hide"),t.showPagingInfo()))},showPagingInfo:function(){var e=this.getListViewContainer(),t=jQuery("#totalCount",e).val(),i=jQuery(".pageNumbersText",e).text().trim()+" "+app.vtranslate("of")+" "+t+"  ";0!==parseInt(jQuery("#noOfEntries",e).val())?jQuery(".pageNumbersText",e).html(i):jQuery(".pageNumbersText",e).html("")},registerEventToShowQuickPreview:function(){var e=this,t=e.getListViewContainer();t.on("click",".quickView",function(i){var r=t.find(i.currentTarget),a=r.data("app"),n=r.closest(".listViewEntries").data("id");e.showQuickPreviewForId(n,a)})},registerMoreRecentUpdatesClickEvent:function(e,t){e.find(".moreRecentUpdates").on("click",function(){var e="index.php?view=Detail&mode=showRecentActivities&page=1&module="+app.getModuleName()+"&record="+t+"&tab_label=LBL_UPDATES";window.location.href=e})},registerNextRecordClickEvent:function(e){var t=this;e.find("#quickPreviewNextRecordButton").on("click",function(e){var i=jQuery(e.currentTarget),r=i.data("record"),a=i.data("app");t.showQuickPreviewForId(r,a)})},registerPreviousRecordClickEvent:function(e){var t=this;e.find("#quickPreviewPreviousRecordButton").on("click",function(e){var i=jQuery(e.currentTarget),r=i.data("record"),a=i.data("app");t.showQuickPreviewForId(r,a)})},showQuickPreviewForId:function(e,t){Vtiger_Index_Js.getInstance().showQuickPreviewForId(e,this.getModuleName(),t)},registerDynamicListHeaders:function(){var e=this;this.getListViewContainer();jQuery("#filterListColumns").length>0&&jQuery("#filterListColumns").instaFilta({targets:".listColumnFilter .list-group-item",sections:".listColumnFilter .block-item",hideEmptySections:!0,beginsWith:!1,caseSensitive:!1,typeDelay:0}),jQuery(".listColumnFilter .dropdown-menu").on("click",function(e){e.stopPropagation()});app.helper.showVerticalScroll(jQuery(".viewColumnsList"),{setHeight:""}),jQuery(".viewColumnsList").on("click",'input[type="checkbox"]',function(e,t){var i=$('input[name="list_headers"]'),r=JSON.parse(i.val());if($(this).is(":checked"))r=app.helper.array_merge(r,[$(this).val()]);else{delete r[app.helper.array_search($(this).val(),r)]}i.val(JSON.stringify(r))}),jQuery("#updateListing").on("click",function(t,i){void 0!==i&&i.noFilterLoad||e.loadListViewRecords()})},checkListRecordSelected:function(){var e=this.readSelectedIds();return"object"==typeof e&&e.length<=0},updatePagination:function(){var e=this.getListViewContainer(),t=jQuery("#previousPageExist",e).val(),i=jQuery("#nextPageExist",e).val(),r=jQuery("#PreviousPageButton",e),a=jQuery("#NextPageButton",e),n=jQuery("#PageJump",e),s=parseInt(jQuery("#noOfEntries",e).val()),o=parseInt(jQuery("#pageStartRange",e).val()),l=parseInt(jQuery("#pageEndRange",e).val()),d=jQuery("#totalPageCount",e).text(),c=jQuery(".totalNumberOfRecords",e),u=jQuery(".pageNumbersText",e),p=jQuery("#pageNumber",e).val();if(jQuery("#pageToJump",e).val(p),d>1&&n.removeAttr("disabled"),""!==t?r.removeAttr("disabled"):""===t&&r.attr("disabled","disabled"),""!==i?a.removeAttr("disabled"):""!==i&&1!==d||a.attr("disabled","disabled"),0!==s){var g=o+" "+app.vtranslate("to")+" "+l;u.html(g),c.removeClass("hide")}else u.html("<span>&nbsp;</span>"),c.hasClass("hide")||c.addClass("hide")},initializePaginationEvents:function(){var e=this,t=this.getComponentInstance("Vtiger_Pagination_Js"),i=e.getListViewContainer();t.initialize(i),app.event.on(t.nextPageButtonClickEventName,function(){var t=i.find("#pageLimit").val(),r=i.find("#noOfEntries").val(),a=i.find("#nextPageExist").val(),n=i.find("#pageNumber").val(),s=parseInt(parseFloat(n))+1;if(r===t&&a){i.find("#pageNumber").val(s),e.loadListViewRecords({})}}),app.event.on(t.previousPageButtonClickEventName,function(){var t=i.find("#pageNumber").val(),r=parseInt(parseFloat(t))-1;if(t>1){i.find("#pageNumber").val(r),e.loadListViewRecords({})}}),app.event.on(t.pageJumpButtonClickEventName,function(t,i){e.pageJump()}),app.event.on(t.totalNumOfRecordsButtonClickEventName,function(t,i){e.totalNumOfRecords(i)}),app.event.on(t.pageJumpSubmitButtonClickEvent,function(t,i){e.pageJumpOnSubmit(i)})},saveTag:function(e){var t=jQuery.Deferred(),i={module:app.getModuleName(),action:"TagCloud",mode:"saveTags"},r=this.getCurrentCvId();i.viewname=r,i.search_params=JSON.stringify(this.getListSearchParams()),i=jQuery.extend(i,this.getListSelectAllParams(!1));i=jQuery.extend(i,e);return app.request.post({data:i}).then(function(e,i){null==e?t.resolve(i):t.reject(i)}),t.promise()},constructTagElement:function(e){var t=jQuery(jQuery("#dummyTagElement").html()).clone(!0);return t.attr("data-id",e.id).attr("data-type",e.type),t.find(".tagLabel").text(e.name),t},addTagToList:function(e){var t=jQuery("#listViewTagContainer"),i=parseInt(t.data("listTagCount"));t.find(">.tag").length<i?t.append(e):t.find(".moreListTags").append(e);var r=t.find(".moreTagCount"),a=parseInt(r.text());a++,r.text(a),r.hasClass("hide")&&a>0&&!t.find(".moreListTags").hasClass("hide")&&r.removeClass("hide")},checkAndAddTagsToList:function(e){var t=this,i=jQuery("#listViewTagContainer");e.each(function(e,r){var a=jQuery(r),n=a.data("id");i.find('[data-id="'+n+'"]').length<=0&&(a.find(".deleteTag").remove(),t.addTagToList(a))})},addToExistingTagSelector:function(e){var t=jQuery(".showAllTagContainer").find(".currentTagMenu");if(t.find('.tag[data-id="'+e.data("id")+'"]').length<=0){var i=e;i.find(".editTag").remove();var r=t.find(".dummyExistingTagElement").clone(!0).removeClass("dummyExistingTagElement");r.find(".tag").replaceWith(i),r.removeClass("hide").appendTo(t.find("ul"))}},showAllTags:function(e){var t=this,i={},r=this.getCurrentCvId();i.viewname=r,i.search_params=JSON.stringify(this.getListSearchParams()),i=jQuery.extend(i,this.getListSelectAllParams(!1)),app.event.one("post.MassTag.save",function(e,i,r){var a=i.find(".currentTag .tag");t.checkAndAddTagsToList(a);var n=r.new;for(var s in n){var o=n[s];o.id=s;var l=t.constructTagElement(o);t.addTagToList(l.clone(!0)),t.addToExistingTagSelector(l.clone(!0))}app.helper.showSuccessNotification({message:""})}),app.event.trigger("Request.MassTag.show",e,i)},massRemoveTag:function(e){var t=this,i=jQuery("#listViewTagContainer").find('[data-id="'+e+'"]').find(".tagLabel").text(),r=app.vtranslate("JS_REMOVE_MASS_TAG_WARNING",i);app.helper.showConfirmationBox({message:r}).then(function(){var i=t.getComponentInstance("Vtiger_Tag_Js"),r={},a=t.getCurrentCvId();r.search_params=JSON.stringify(t.getListSearchParams()),(r=jQuery.extend(r,t.getListSelectAllParams(!1))).viewname=a;var n={},s=new Array,o=new Array,l=new Array;s.push(e),n.existing=l,n.new=o,n.deleted=s,r.tagsList=n,i.saveTag(r).then(function(e){t.clearList(),t.loadListViewRecords().then(function(e){app.helper.showSuccessNotification({message:""})})})})},registerEditLink:function(){jQuery("#page").on("click",'a[name="editlink"]',function(e){var t=jQuery(e.currentTarget).data("url"),i=Vtiger_List_Js.getInstance().getDefaultParams();for(var r in i)i[r]?(i["return"+r]=i[r],delete i[r]):delete i[r];e.preventDefault(),e.stopPropagation(),window.location.href=t+"&"+$.param(i)})},registerDynamicDropdownPosition:function(e,t){"function"==typeof jQuery.fn.sadropdown&&jQuery("."+e).find(".dropdown-toggle").sadropdown({relativeTo:"."+t})},registerPostLoadListViewActions:function(){""!=this.getRecordSelectTrackerInstance().getSelectedIds()?this.enableListViewActions():this.disableListViewActions(),this.registerDynamicDropdownPosition(),this.registerDropdownPosition()},enableListViewActions:function(){jQuery(".btn-group.listViewActionsContainer").find("button").removeAttr("disabled"),jQuery(".btn-group.listViewActionsContainer").find("li").removeClass("hide")},disableListViewActions:function(){jQuery(".btn-group.listViewActionsContainer").find("button").attr("disabled","disabled"),jQuery(".btn-group.listViewActionsContainer").find(".dropdown-toggle").removeAttr("disabled"),jQuery(".btn-group.listViewActionsContainer").find("li").addClass("hide");var e=jQuery(".btn-group.listViewActionsContainer").find("li.selectFreeRecords");e.removeClass("hide"),0==e.length&&jQuery(".btn-group.listViewActionsContainer").find(".dropdown-toggle").attr("disabled","disabled")},registerEmailFieldClickEvent:function(){this.getListViewContainer().on("click",".emailField",function(e){e.stopPropagation()})},registerPhoneFieldClickEvent:function(){this.getListViewContainer().on("click",".phoneField",function(e){e.stopPropagation()})},registerConfigureColumnsEvents:function(){var e=this;this.getListViewContainer().on("click",".listColumnFilter",function(t){if(jQuery(t.currentTarget).hasClass("disabled"))return!1;var i={module:app.module(),view:"ListAjax",mode:"ShowListColumnsEdit",source_module:app.module(),cvid:e.getCurrentCvId()},r=function(e){var t=jQuery("#selectedFieldsList"),i=e.find(".selectedFieldsListContainer"),r=jQuery("#avialFieldsList"),a=e.find(".avialFieldsListContainer");app.helper.showVerticalScroll(a,{setHeight:"200",advanced:{updateOnSelectorChange:"true"}}),app.helper.showVerticalScroll(i,{setHeight:"250",advanced:{updateOnSelectorChange:"true"}}),t.sortable({start:function(e,t){t.item.hasClass("active")||t.item.addClass("active")},stop:function(e,t){t.item.removeClass("active")}}),e.find(".searchAvailFields").instaFilta({onFilterComplete:function(e){e.length>0&&jQuery.each(e,function(e,t){var i=jQuery(t).closest(".instafilta-section").find(".availFieldBlock");i.find("i").hasClass("fa-caret-right")&&i.find('a[data-parent="#accordion"]').trigger("click")})}}),a.on("click",'.availFieldBlock a[data-parent="#accordion"]',function(e){var t=jQuery(e.currentTarget).find("i");if(t.hasClass("fa-caret-right")?t.removeClass("fa-caret-right").addClass("fa-caret-down"):t.removeClass("fa-caret-down").addClass("fa-caret-right"),n&&n.autoIconChangeForOthers)return!0}),t.on("click",".removeField",function(e){if(t.find(".item").length<=1)return app.helper.showErrorNotification({message:app.vtranslate("JS_ATLEAST_SELECT_ONE_FIELD")}),!1;var i=jQuery(e.currentTarget).parent(".item");a.find('.item[data-cv-columnname="'+i.attr("data-cv-columnname")+'"]').removeClass("hide"),i.remove()}),r.on("click",".item",function(e){if(t.find(".item").length>15)return app.helper.showErrorNotification({message:app.vtranslate("JS_ADD_MAX_15_ITEMS")}),!1;var r=jQuery(e.currentTarget),a=i.find(".item-dummy").clone();a.removeClass("hide item-dummy").addClass("item"),a.attr("data-cv-columnname",r.attr("data-cv-columnname")),a.attr("data-columnname",r.attr("data-columnname")),a.attr("data-field-id",r.attr("data-field-id")),a.find(".fieldLabel").html(r.find(".fieldLabel").html()),a.appendTo(t),r.addClass("hide")});var n={submitHandler:function(e){var i=jQuery(e).serializeFormData(),r=[],a=t.find(".item");jQuery.each(a,function(e,t){var i=jQuery(t);r.push(i.attr("data-cv-columnname"))}),i.source_module=app.module(),i.columnslist=JSON.stringify(r),app.helper.showProgress(),app.request.post({data:i}).then(function(e,t){if(app.helper.hideProgress(),e)return app.helper.showErrorNotification({message:e}),!1;app.helper.showSuccessNotification({message:t.message}),app.helper.hideModal();var i=app.getAppName(),r=t.listviewurl+"&app="+i;window.location.href=r})}};e.find(".configColumnsForm").vtValidate(n)};app.helper.showProgress(),app.request.post({data:i}).then(function(e,t){app.helper.hideProgress(),e||app.helper.showModal(jQuery(t),{cb:r})})})},getFieldValue:function(e,t){return t.closest("tr").find('[name="'+e+'"]').val()},registerEventToHandleStickyHeadOnWindowScroll:function(){var e=this;jQuery(window).scroll(function(){var t=e.getListViewContainer().find(".sticky-thead");if("block"==t.css("display")){var i=jQuery(t).find("select.select2");if(i.length>1)jQuery(i).each(function(e,t){var i=jQuery(t);i.closest("th").find("div.select2-container").remove(),vtUtils.showSelect2ElementView(i)});else{i.closest("th").find("div.select2-container").remove(),vtUtils.showSelect2ElementView(i)}}})},registerPostListLoadListener:function(){var e=this;app.event.on("post.listViewFilter.click",function(t,i){i&&(vtUtils.applyFieldElementsView(i),e.filterClick=!1),e.registerFloatingThead()})},registerChangeLinks:function(){var e=this;$(document).ready(function(){e.changeLinks("#page nav .app-nav div.module-breadcrumb.module-breadcrumb-List p  a","add"),$(document).on("click","#convertListLinks",function(){$("#convertListLinks").is(":checked")?(e.changeLinks("#myList ul  li  a","add"),e.changeLinks("#sharedList ul  li  a","add")):(e.changeLinks("#myList ul  li  a","remove"),e.changeLinks("#sharedList ul  li  a","remove"))}),e.changeLinks("#myList ul  li  a","add"),e.changeLinks("#sharedList ul  li  a","add"),jQuery('<div class="sidebar-header clearfix"><h5 class="pull-left">'+CONVERTLINKSMSG.CONVERTLINKS+'</h5><input type="checkbox" id="convertListLinks"  checked style="margin-top: 10px" class="pull-right inputElement" /></div><hr>').insertBefore("#module-filters  div.sidebar-header")})},changeLinks:function(e,t){jQuery(e).each(function(){this.href="remove"==t?this.href.replace("Grid","List"):this.href.replace("List","Grid")})},registerEvents:function(){var e=this;this._super(),this.registerListViewSort(),this.registerRemoveListViewSort(),this.registerRowClickEvent(),this.registerRowDoubleClickEvent(),this.registerListViewBasicActions(),this.registerListViewSearch(),this.registerDeleteRecordClickEvent(),this.registerCheckBoxClickEvent(),this.registerSelectAllClickEvent(),this.registerDeSelectAllClickEvent(),this.registerListViewMainCheckBoxClickEvent(),this.registerStarToggle(),this.registerStarUnstarFilter(),this.registerDynamicListHeaders(),this.registerEditLink(),this.registerEmailFieldClickEvent(),this.registerPhoneFieldClickEvent(),this.registerDynamicDropdownPosition(),this.registerDropdownPosition(),this.registerConfigureColumnsEvents(),this.registerChangeLinks();this.getRecordSelectTrackerInstance().registerEvents(),this.registerPostListLoadListener(),this.registerPostLoadListViewActions(),app.event.on("post.listViewMassEditSave",function(){e.loadListViewRecords({}),e.clearList()}),this.registerEventToShowQuickPreview(),setTimeout(function(){e.registerFloatingThead()},10),app.event.on("Vtiger.Post.MenuToggle",function(){e.reflowList()}),this.registerDynamicDropdownPosition(),this.registerHeaderReflowOnListSearchSelections(),this.registerDropdownPosition(),e.initializePaginationEvents()},registerHeaderReflowOnListSearchSelections:function(){var e=this.getListViewContainer(),t=this,i=jQuery("#listview-table");e.on("select2-selecting select2-close select2-removed",".listSearchContributor",function(){t.reflowList(i)})},registerDropdownPosition:function(e){void 0===e&&(e="#page"),jQuery(".table-actions").on("click",".dropdown",function(t){var i=jQuery(this).closest(e),r=jQuery(this).closest(".dropdown"),a=jQuery(t.currentTarget);if(!(a.find("[data-toggle]").length<=0)){var n=a.find(".dropdown-menu");n.find("li a").css("padding","0 6px","important");var s=n.clone(!0);s.data("original-menu",n),n.css("position","relative"),n.css("display","none");var o,l,d,c="auto",u="auto";"#page"===e&&(o=a.offset().top+a.height(),l=a.offset().left,d=jQuery(window).height()-o+a.height());var p=jQuery(window).height()-a.offset().top,g=app.getUserLanguage().slice(0,2),h=l;void 0!==g&&"fa"===g&&(h=l-130),p<250?(c="auto",u=d+"px"):(c=o+"px",u="auto"),s.css({display:"block",position:"absolute",top:c,left:h+"px",width:"130px",bottom:u}).appendTo(i),$("#table-content").scroll(function(){var e,t;$("#table-content").height()-r.position().top<250?(e="auto",t=a.height()):(e=a.height(),t="auto"),r.hasClass("open")?s.css({display:"block",top:e,position:"absolute",bottom:t,left:0,"z-index":100}).appendTo(r):n.css("display","none")}),a.on("hidden.bs.dropdown",function(){n.removeClass("invisible"),s.remove(),jQuery(".listViewEntries").removeClass("dropDownOpen")})}}),jQuery(".listViewEntries").mouseleave(function(e){var t=jQuery(e.currentTarget).find(".dropdown");setTimeout(function(){0==jQuery(".dropdown-menu:hover").length?(t.hasClass("open")&&jQuery(e.currentTarget).find(".dropdown").trigger("click"),jQuery(e.currentTarget).removeClass("dropDownOpen")):jQuery(e.currentTarget).addClass("dropDownOpen")},50)})},getListViewContentHeight:function(){var e=.76103500761035*jQuery(window).height(),t=jQuery("#listview-table");if(t.length&&!t.find("tr.emptyRecordsDiv").length){var i=jQuery("#listview-table").height();i<e&&(e=i+3)}return e+1e3+"px"},getListViewContentWidth:function(){return"100%"},reflowList:function(){if("function"==typeof $.fn.perfectScrollbar&&"function"==typeof $.fn.floatThead){var e=jQuery("#listview-table");if(e.length){var t=this.getListViewContentHeight(),i=this.getListViewContentWidth(),r=e.closest(".table-container");r.css({position:"relative",height:t,width:i}),r.perfectScrollbar("update"),e.floatThead("reflow")}}},registerFloatingThead:function(){if("function"==typeof $.fn.perfectScrollbar&&"function"==typeof $.fn.floatThead){var e=jQuery("#listview-table");if(e.length){var t=this.getListViewContentHeight(),i=this.getListViewContentWidth(),r=e.closest(".table-container");r.css({position:"relative",height:t,width:i}),r.perfectScrollbar({wheelPropagation:!0}),e.floatThead({scrollContainer:function(e){return e.closest(".table-container")}})}}},getSelectedRecordCount:function(){var e=0,t=this.readSelectedIds();if(t)if("all"!=t)e=t.length;else{var i=this.readExcludedIds().length;e=jQuery("#totalRecordsCount").text()-i}return e}}),jQuery.Class("Vtiger_GridRecordSelectTracker_Js",{getInstance:function(){return new Vtiger_GridRecordSelectTracker_Js}},{selectedIds:[],selectAllMode:!1,excludedIds:[],cvId:"",setCvId:function(e){this.cvId=e},registerRowCheckListener:function(){var e=this;jQuery(document).on("Post.ListRow.Checked","div.listViewEntries",function(t,i){e.selectAllMode?e.excludedIds.splice($.inArray(i.id,e.excludedIds),1):-1==jQuery.inArray(i.id,e.selectedIds)&&e.selectedIds.push(i.id)}),jQuery(document).on("Post.ListRow.UnChecked","div.listViewEntries",function(t,i){e.selectAllMode?-1==jQuery.inArray(i.id,e.excludedIds)&&e.excludedIds.push(i.id):e.selectedIds.splice($.inArray(i.id,e.selectedIds),1)})},registerListSelectAllListener:function(){var e=this;jQuery(document).on("Post.ListSelectAll",function(t,i){e.selectedIds=[],e.selectAllMode=i.mode,e.cvId=i.cvId}),jQuery(document).on("Post.ListDeSelectAll",function(t,i){e.selectAllMode=i.mode,e.clearList()})},getSelectedAndExcludedIds:function(e){var t=this.getSelectedIds();if(void 0==t||null==t||0==t.length)return!1;1!=this.selectAllMode&&e&&(t=JSON.stringify(t));return{selected_ids:t,excluded_ids:this.getExcludedIds(e),viewname:this.getCvid()}},getSelectedIds:function(){return 1==this.selectAllMode?"all":this.selectedIds},getCvid:function(){return this.cvId},getExcludedIds:function(e){return e?JSON.stringify(this.excludedIds):this.excludedIds},getSelectAllMode:function(){return this.selectAllMode},clearList:function(){this.selectedIds=[],this.excludedIds=[],this.selectAllMode=!1,this.cvId=""},registerEvents:function(){this.registerRowCheckListener(),this.registerListSelectAllListener()}});